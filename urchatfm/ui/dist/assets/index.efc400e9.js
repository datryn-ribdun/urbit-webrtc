var ce=Object.defineProperty,le=Object.defineProperties;var de=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var W=(e,t,a)=>t in e?ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,w=(e,t)=>{for(var a in t||(t={}))K.call(t,a)&&W(e,a,t[a]);if(T)for(var a of T(t))F.call(t,a)&&W(e,a,t[a]);return e},E=(e,t)=>le(e,de(t));var I=(e,t)=>{var a={};for(var i in e)K.call(e,i)&&t.indexOf(i)<0&&(a[i]=e[i]);if(e!=null&&T)for(var i of T(e))t.indexOf(i)<0&&F.call(e,i)&&(a[i]=e[i]);return a};import{c as B,U as ue,r as f,R as n,u as q,C as he,a as ge,b as me,O as pe,T as fe,d as be,e as x,f as G,g as Y,s as we,D as ve,h as Ee,i as Se,S as J,j as O,B as ye,k as xe}from"./vendor.2ba24969.js";const Ce=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function a(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=a(r);fetch(r.href,s)}};Ce();var ke=Object.defineProperty,Q=Object.getOwnPropertySymbols,Ne=Object.prototype.hasOwnProperty,De=Object.prototype.propertyIsEnumerable,A=(e,t,a)=>t in e?ke(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,X=(e,t)=>{for(var a in t||(t={}))Ne.call(t,a)&&A(e,a,t[a]);if(Q)for(var a of Q(t))De.call(t,a)&&A(e,a,t[a]);return e},u=(e,t,a)=>(A(e,typeof t!="symbol"?t+"":t,a),a),Re=class extends EventTarget{constructor(e,t,a=window.urbit){super();u(this,"_urbit"),u(this,"configuration"),u(this,"dap"),u(this,"subscriptionId"),u(this,"onincomingcall"),u(this,"onhungupcall"),u(this,"onerror"),this._urbit=a,this.configuration=t,this.dap=e,this.onincomingcall=()=>{},this.onhungupcall=()=>{},this.onerror=()=>{},this.subscriptionId=null}initialize(){return this.subscriptionId=this._urbit.subscribe({app:"switchboard",path:`/incoming/${this.dap}`,err:e=>this.onerror(e),event:e=>this.handleIncoming(e),quit:()=>this.initialize()}),this.subscriptionId}handleIncoming(e){e.type=="incoming"?this.incomingCall(e):e.type=="hangup"&&this.hungupCall(e.uuid)}set urbit(e){this._urbit=e,this.initialize()}incomingCall(e){const t=new _e(e.peer,this.dap,e.uuid,this._urbit,this.configuration);this.onincomingcall(t),this.dispatchEvent(t)}hungupCall(e){const t=new Z(e);this.onhungupcall(t),this.dispatchEvent(t)}call(e,t){return new M(e,t,void 0,this._urbit,this.configuration)}},M=class extends RTCPeerConnection{constructor(e,t,a,i,r){super(r);u(this,"urbit"),u(this,"reconnect"),u(this,"peer"),u(this,"dap"),u(this,"uuid"),u(this,"subscriptionId"),u(this,"urbitState"),u(this,"signallingReady"),u(this,"signallingReadyPromise"),u(this,"signallingState"),u(this,"onerror"),u(this,"onurbitstatechanged"),this.urbit=i,this.reconnect=!1,this.peer=e,this.dap=t,this.uuid=a,this.subscriptionId=null,this.onerror=()=>{},this.onurbitstatechanged=()=>{},this.signallingReady=null,this.signallingReadyPromise=new Promise(s=>this.signallingReady=()=>{this.signallingReady=()=>{},s()}),this.onicecandidate=s=>this.signallingState.whenDoneSending(()=>{s.candidate!==null&&this.canTrickleIceCandidates&&this.signallingReadyPromise.then(()=>{var o;this.urbit.verbose&&console.log("Sending ICE candidate for address ${evt.candidate.address}:${evt.candidate.port}"),this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:X({uuid:this.uuid,tag:"icecandidate"},(o=s.candidate)==null?void 0:o.toJSON())})}).catch(o=>this.closeWithError(o))}),this.onnegotiationneeded=()=>this.renegotiate(),this.urbitState=null,this.signallingState=new Ie}async initialize(){this.reconnect?await this.resubscribe():typeof this.uuid=="undefined"?(this.dispatchUrbitState("dialing"),await this.dial()):(this.dispatchUrbitState("incoming-ringing"),await this.subscribe())}static async reconnect(e){var t=e.uuid,a=e.urbit?e.urbit:window.urbit,i=await a.scry({app:"switchboard",path:`/call/${t}/peer`}),r=await a.scry({app:"switchboard",path:`/call/${t}/dap`}),s=new M(i,r,t,a);return s.reconnect=!0,s}async dial(){await this.urbit.subscribe({app:"switchboard",path:"/uuid",err:e=>this.closeWithError(e),event:e=>this.ring(e),quit:()=>{}})}async ring(e){return this.uuid=e,this.urbit.verbose&&console.log("Call UUID:",this.uuid),await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{uuid:this.uuid,tag:"place-call",peer:this.peer,dap:this.dap}}).catch(t=>this.closeWithError(t)),this.subscribe()}subscribe(){return this.subscriptionId=this.urbit.subscribe({app:"switchboard",path:`/call/${this.uuid}`,err:e=>this.closeWithError(e),event:e=>this.handleFact(e),quit:()=>this.resubscribe()}),this.subscriptionId}async resubscribe(){if(this.connectionState!=="closed"){await this.subscribe();const e=await this.urbit.scry({app:"switchboard",path:`/call/${this.uuid}/last-remote`});e!==null&&(this.signallingState.startSettingRemote(),await this.setRemoteDescription(e.msg),this.signallingState.doneSettingRemote()),this.restartIce()}else throw"Will not resubscribe for closed connection"}close(){var e=new Promise(a=>{super.close(),a()}),t=this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{tag:"reject",uuid:this.uuid}});Promise.all([e,t]).then(()=>{this.subscriptionId!==null&&this.subscriptionId.then(a=>this.urbit.unsubscribe(a))})}remoteHungup(){this.connectionState!="closed"&&(super.close(),super.dispatchEvent(new Z(this.uuid||"")))}closeWithError(e){this.close(),console.log("Closed with error",e),this.onerror(e)}async sendSignal(){var e;const t=this.signallingState.waitingType();if(this.urbit.verbose&&console.log("Sending SDP ${signalType}"),this.signallingState.sending(),t==="offer"){const a=await this.createOffer();await this.setLocalDescription(a),this.canTrickleIceCandidates||await this.iceCandidatesGathered()}else{const a=await this.createAnswer();await this.setLocalDescription(a),this.canTrickleIceCandidates||await this.iceCandidatesGathered()}await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:X({uuid:this.uuid,tag:"sdp"},(e=this.localDescription)==null?void 0:e.toJSON())}),await this.signallingState.doneSending(this.askSignal.bind(this))}async askSignal(){await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{uuid:this.uuid,tag:"ask-signal"}})}async askSendSignal(e){switch(await this.signallingReadyPromise,e){case"offer":this.signallingState.needToMakeOffer();break;case"answer":this.signallingState.gotOffer();break;default:throw"signalType must be offer or answer"}await this.askSignal()}handleFact(e){switch(e.tag){case"connection-state":this.signallingState.whenDoneSettingRemote(()=>this.dispatchUrbitState(e.connectionState));return;case"hungup":this.remoteHungup();return;case"sdp":this.urbit.verbose&&console.log("Got SDP ${fact.type}"),this.signallingState.startSettingRemote(),this.handleSDP(e).then(()=>this.signallingState.doneSettingRemote());return;case"icecandidate":if(this.urbit.verbose){const t=new RTCIceCandidate(e);console.log(`Got ICE candidate with address ${t.address}:${t.port}`)}this.signallingState.whenDoneSettingRemote(()=>{this.addIceCandidate(e)})}}async handleSDP(e){await this.setRemoteDescription(e),e.type==="offer"&&await this.askSendSignal("answer")}dispatchUrbitState(e){switch(this.urbit.verbose&&console.log("Switchboard state",e),e){case"connected-our-turn":case"connected-their-turn":this.signallingReady&&this.signallingReady();break;case"connected-our-turn-asked":this.sendSignal().catch(a=>this.closeWithError(a));break}this.urbitState=e;const t=new Te(this.uuid||"",e);this.dispatchEvent(t),this.onurbitstatechanged(t)}async renegotiate(){await this.askSendSignal("offer")}setConfiguration(e){const t=super.getConfiguration().iceServers;super.setConfiguration(e),e.iceServers!==t&&this.restartIce()}async iceCandidatesGathered(){const e=new AbortController;return new Promise(a=>{this.addEventListener("icegatheringstatechange",()=>{this.iceGatheringState=="complete"&&a()},{signal:e.signal}),this.iceGatheringState=="complete"&&a()}).then(()=>e.abort())}},_e=class extends Event{constructor(e,t,a,i,r){super("incomingcall");u(this,"type","incomingcall"),u(this,"peer"),u(this,"dap"),u(this,"uuid"),u(this,"urbit"),u(this,"configuration"),this.peer=e,this.dap=t,this.uuid=a,this.urbit=i,this.configuration=r}get call(){return{peer:this.peer,dap:this.dap,uuid:this.uuid}}answer(){return new M(this.peer,this.dap,this.uuid,this.urbit,this.configuration)}async reject(){return this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{tag:"reject",uuid:this.uuid}})}},Z=class extends Event{constructor(e){super("hungupcall");u(this,"type","hungupcall"),u(this,"uuid"),this.uuid=e}},Te=class extends Event{constructor(e,t){super("statechanged");u(this,"type","statechanged"),u(this,"uuid"),u(this,"urbitState"),this.uuid=e,this.urbitState=t}},Ie=class extends EventTarget{constructor(){super();u(this,"_state"),u(this,"_settingRemote"),u(this,"_settingRemoteDoneK"),u(this,"_whenDoneSendingK"),this._settingRemote=!1,this._settingRemoteDoneK=()=>{},this._whenDoneSendingK=()=>{},this._state="stable"}startSettingRemote(){this._settingRemote=!0}doneSettingRemote(){this._settingRemote=!1,this._settingRemoteDoneK(),this._settingRemoteDoneK=()=>{}}whenDoneSettingRemote(e){if(this._settingRemote){const t=this._settingRemoteDoneK;this._settingRemoteDoneK=()=>{t(),e()}}else e()}needToMakeOffer(){switch(this._state){case"stable":this._state="waiting-to-send-offer";break;case"sending":this._state="sending-waiting-to-send-offer";break}}gotOffer(){switch(this._state){case"stable":case"waiting-to-send-offer":this._state="waiting-to-send-answer";break;case"waiting-to-send-answer":break;case"sending":case"sending-waiting-to-send-offer":throw"Cannot receive SDP while sending"}}sending(){switch(this._state){case"waiting-to-send-offer":case"waiting-to-send-answer":this._state="sending";break;case"sending":case"sending-waiting-to-send-offer":throw"Cannot send while sending";case"stable":throw"Cannot send with nothing to send"}}doneSending(e){switch(this._state){case"sending":this._state="stable",this._whenDoneSendingK(),this._whenDoneSendingK=()=>{};break;case"sending-waiting-to-send-offer":this._state="waiting-to-send-offer",this._whenDoneSendingK(),this._whenDoneSendingK=()=>{},e();break;default:throw"Cannot be done sending if not sending"}}whenDoneSending(e){switch(this._state){case"stable":e();break;default:const t=this._whenDoneSendingK;this._whenDoneSendingK=()=>{t(),e()}}}waitingType(){switch(this._state){case"waiting-to-send-offer":return"offer";case"waiting-to-send-answer":return"answer";default:throw"Asked for waiting type but not waiting to send anything"}}},Oe=Object.defineProperty,Me=(e,t,a)=>t in e?Oe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,v=(e,t,a)=>(Me(e,typeof t!="symbol"?t+"":t,a),a),Pe=class extends EventTarget{constructor(e=window.urbit){super();v(this,"urbit"),v(this,"iceServers"),v(this,"state"),v(this,"uid"),v(this,"oniceserver"),v(this,"onstatechange"),this.urbit=e,this.iceServers=[],this.state="uninitialized",this.oniceserver=()=>{},this.onstatechange=()=>{},this.uid="";for(let t=0;t<32;t++)this.uid+=Math.floor(Math.random()*16).toString(16)}async initialize(){await this.urbit.subscribe({app:"icepond",path:`/ice-servers/${this.uid}`,err:t=>this.handleError(t),event:t=>this.iceServer(t),quit:()=>this.done()}),this.iceServers=[],this.state="acquiring";const e=new $(this.state);this.dispatchEvent(e),this.onstatechange(e)}handleError(e){console.log("icepond error: ",e),this.state="error";const t=new $(this.state);this.dispatchEvent(t),this.onstatechange(t)}iceServer(e){this.iceServers.includes(e)==!1&&this.iceServers.push(e);const t=new je(e,this.iceServers);this.dispatchEvent(t),this.oniceserver(t)}done(){this.state="done";const e=new $(this.state);this.dispatchEvent(e),this.onstatechange(e)}},$=class extends Event{constructor(e){super("statechange");v(this,"state"),this.state=e}},je=class extends Event{constructor(e,t){super("iceserver");v(this,"newIceServer"),v(this,"iceServers"),this.newIceServer=e,this.iceServers=t}},ze=Pe;const ee=!1,H="urchatfm",U=B((e,t)=>{const a={iceServers:[]},i=new Re(H,a);i.addEventListener("incomingcall",s=>{t().incomingCall===null?e({incomingCall:s}):s.reject()}),console.log("useMock:"+ee);const r=new ue("","");return r.ship=window.ship,i.urbit=r,{urbit:r,icepond:null,configuration:{iceServers:[]},urbitRtcApp:i,incomingCall:null,ongoingCall:null,isCaller:!1,setUrbit:s=>{const o=s;t().urbitRtcApp.urbit=o,e({urbit:o})},startIcepond:()=>e(s=>{console.log("YOU HAVE AUTHED WITH: "+s.urbit.ship),console.log("attempting icepond");const o=new ze(s.urbit);o.oniceserver=d=>{e(c=>{const l=E(w({},c.configuration),{iceServers:d.iceServers});return console.log("icepond config:"),console.log(l),c.urbitRtcApp!==null&&(c.urbitRtcApp.configuration=l),c.incomingCall!==null&&(c.incomingCall.configuration=l),c.ongoingCall!==null&&c.ongoingCall.conn.setConfiguration(l),E(w({},c),{configuration:l})},!0)},o.initialize(),e({icepond:o})}),placeCall:async(s,o)=>{const{urbitRtcApp:d,hungup:c,startIcepond:l}=t();console.log("placeCall");const h=d.call(s,H);o(h),h.addEventListener("hungupcall",c),await h.initialize();const g={peer:s,dap:H,uuid:h.uuid};l();const p={conn:h,call:g};return e({isCaller:!0,ongoingCall:p}),p},answerCall:async s=>{const{incomingCall:o,hungup:d,startIcepond:c}=t(),l=o.call,h=o.answer();h.addEventListener("hungupcall",d),s(l.peer,h),await h.initialize(),c();const g={conn:h,call:l};return e({isCaller:!1,ongoingCall:g,incomingCall:null}),g},reconnectCall:async(s,o)=>{const d=t().urbit,c=await M.reconnect({urbit:d,uuid:s}),l={uuid:s,peer:c.peer,dap:c.dap},h={call:l,conn:c},{hungup:g,startIcepond:p}=t();return c.addEventListener("hungupcall",g),o(l.peer,c),await c.initialize(),p(),e({ongoingCall:h}),h},rejectCall:()=>e(s=>(s.incomingCall.reject(),{incomingCall:null})),hangup:()=>e(s=>(s.ongoingCall&&s.ongoingCall.conn.close(),E(w({},s),{ongoingCall:null}))),hungup:()=>e({ongoingCall:null})}});var Ae="/apps/urchatfm/assets/ring.b27464db.wav";const $e=({caller:e,answerCall:t,rejectCall:a})=>(f.exports.useEffect(()=>{new Audio(Ae).play()},[]),n.createElement("div",{className:"fixed top-4 right-4 inline-block px-8 py-4 space-y-4 bg-gray-100 rounded-xl shadow-lg"},n.createElement("h2",null,"Call from ~",n.createElement("span",{className:"font-mono font-semibold"},e)),n.createElement("div",{className:"flex space-x-3"},n.createElement("button",{className:"flex-1 button text-green-900 bg-green-500",onClick:t},"Answer"),n.createElement("button",{className:"flex-1 button text-red-900 bg-red-500",onClick:a},"Reject")))),He=({sendMessage:e,messages:t,ready:a})=>{const{register:i,handleSubmit:r,reset:s}=q({defaultValues:{message:""}}),o=!a&&!ee,d=f.exports.useCallback(({message:c})=>{console.log(c),e(c),s()},[e]);return n.createElement("div",{className:`flex flex-col h-full p-3 sm:p-6 text-sm bg-pink-100 lg:rounded-xl overflow-hidden ${o?"opacity-50":""}`},n.createElement("div",{className:"flex-1 h-full px-4 py-3 bg-white rounded-md overflow-y-auto"},n.createElement("div",{className:"flex flex-col-reverse justify-start"},t.map((c,l)=>n.createElement("div",{className:"mt-4",key:l},n.createElement("span",{className:"font-bold mr-3"},c.speaker,":"),c.message)))),n.createElement("form",{className:"flex-none flex mt-3 sm:mt-6 relative rounded-md focus-within:ring-2 ring-pink-300 focus-within:outline-none",onSubmit:r(d)},n.createElement("label",{htmlFor:"message",className:"sr-only"},"Send a Message:"),n.createElement("input",E(w({id:"message",type:"text",className:"flex-1 input rounded-r-none focus:outline-none"},i("message")),{disabled:o})),n.createElement("button",{type:"submit",disabled:o,className:"flex-none button px-6 text-pink-900 bg-pink-500 rounded-l-none"},"Send")))},C=B((e,t)=>({local:new MediaStream,remote:new MediaStream,video:{enabled:!0,device:null,tracks:[],changeDevice:(a,i)=>P(a,"video",t(),i),toggle:()=>{e({video:te(t().video)})}},audio:{enabled:!0,device:null,tracks:[],changeDevice:(a,i)=>P(a,"audio",t(),i),toggle:()=>{e({audio:te(t().audio)})}},sharedScreen:{enabled:!1,tracks:[],toggle:async()=>{var a=t().sharedScreen;a.enabled?e({sharedScreen:await Le(t())}):e({sharedScreen:await Ve(t())})}},devices:[],resetStreams:()=>{e({local:new MediaStream,remote:new MediaStream})},call:null,getDevices:async a=>{var c;const i=await((c=navigator.mediaDevices)==null?void 0:c.enumerateDevices()),r=i.filter(l=>l.kind==="videoinput"),s=i.filter(l=>l.kind==="audioinput"),o=await P(r[0],"video",t(),a),d=await P(s[0],"audio",t(),a);e({devices:i,video:o,audio:d}),e({call:a})}}));function te(e){return e.enabled=!e.enabled,e.tracks.forEach(t=>{t.enabled=e.enabled}),e}const Ue={video:{facingMode:"user",width:1280,height:719},audio:null};async function Ve(e){const t=e.sharedScreen,a=e.call,i=r=>{var o;console.log("Adding screenshare track to call",r),r.contentHint="screenshare",e.local.addTrack(r);const s=(o=a.conn)==null?void 0:o.addTrack(r);return r.sender=s,r};return t.tracks=(await navigator.mediaDevices.getDisplayMedia()).getTracks().map(i),t.enabled=!0,t}async function Le(e){const t=e.sharedScreen,a=e.call,i=r=>{var s,o,d;console.log("Removing screenshare track from call",r),e.local.removeTrack(r);try{console.log((s=a.conn)==null?void 0:s.getSenders()),(o=a.conn)==null||o.removeTrack(r.sender),console.log("removed screenshare from connection"),console.log((d=a.conn)==null?void 0:d.getSenders())}catch(c){console.log(c)}r.stop()};return t.tracks.forEach(i),t.enabled=!1,t}async function P(e,t,a,i){var l;const r=a[t],s=h=>{var p;console.log("Adding track to call",h),a.local.addTrack(h);const g=(p=i.conn)==null?void 0:p.addTrack(h);return h.sender=g,h},o=h=>{var g;console.log("Removing track from call",h),a.local.removeTrack(h);try{(g=i.conn)==null||g.removeTrack(h.sender)}catch(p){console.log(p)}h.stop()},d={[t]:w({deviceId:e.deviceId},Ue[t])},c=await((l=navigator.mediaDevices)==null?void 0:l.getUserMedia(d));return r.tracks.forEach(o),t==="audio"?r.tracks=c.getAudioTracks().map(s):t==="video"&&(r.tracks=c.getVideoTracks().map(s)),r.device=e,r}const Ke=({className:e="",primary:t=""})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,fillRule:"evenodd",d:"M15.78 14.36a1 1 0 0 1-1.42 1.42l-2.82-2.83-2.83 2.83a1 1 0 1 1-1.42-1.42l2.83-2.82L7.3 8.7a1 1 0 0 1 1.42-1.42l2.83 2.83 2.82-2.83a1 1 0 0 1 1.42 1.42l-2.83 2.83 2.83 2.82z"})),ne=a=>{var i=a,{children:e}=i,t=I(i,["children"]);return n.createElement(me,w({},t),n.createElement(pe,{className:"fixed z-10 top-0 left-0 right-0 bottom-0 dark:bg-white bg-black opacity-30"}),e)},ae=n.forwardRef((s,r)=>{var o=s,{children:e,showCloseIcon:t=!0,className:a="p-6"}=o,i=I(o,["children","showCloseIcon","className"]);return n.createElement(he,E(w({className:"fixed z-40 top-1/2 left-1/2 bg-gray-100 rounded-xl default-ring transform -translate-y-1/2 -translate-x-1/2"},i),{ref:r}),n.createElement("div",{className:`relative ${a}`},e,t&&n.createElement(ge,{className:"absolute top-2 right-2 text-gray-300 dark:text-gray-700 hover:text-gray-400 dark:hover:text-gray-500 focus:text-gray-400 dark:focus:text-gray-500 default-ring rounded"},n.createElement(Ke,{className:"w-7 h-7",primary:"fill-current"}))))}),Fe=fe,We=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:a,d:"M13.59 12l6.7-6.7A1 1 0 0 1 22 6v12a1 1 0 0 1-1.7.7L13.58 12z"}),n.createElement("rect",{width:"14",height:"14",x:"2",y:"5",className:t,rx:"2"})),Be=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,d:"M11 4h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V6h-2v12h2v-2a1 1 0 0 1 2 0v3a1 1 0 0 1-1 1h-3v1a1 1 0 0 1-1.27.96l-6.98-2A1 1 0 0 1 2 19V5a1 1 0 0 1 .75-.97l6.98-2A1 1 0 0 1 11 3v1z"}),n.createElement("path",{className:a,d:"M18.59 11l-1.3-1.3c-.94-.94.47-2.35 1.42-1.4l3 3a1 1 0 0 1 0 1.4l-3 3c-.95.95-2.36-.46-1.42-1.4l1.3-1.3H14a1 1 0 0 1 0-2h4.59z"})),qe=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:a,d:"M12 1a4 4 0 0 1 4 4v6a4 4 0 1 1-8 0V5a4 4 0 0 1 4-4z"}),n.createElement("path",{className:t,d:"M13 18.94V21h3a1 1 0 0 1 0 2H8a1 1 0 0 1 0-2h3v-2.06A8 8 0 0 1 4 11a1 1 0 0 1 2 0 6 6 0 1 0 12 0 1 1 0 0 1 2 0 8 8 0 0 1-7 7.94z"})),Ge=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 272 272",className:e},n.createElement("path",{className:t,d:`M263,14.043H9c-4.971,0-9,4.029-9,9v166c0,4.971,4.029,9,9,9h99.622v41.914H93c-4.971,0-9,4.029-9,9s4.029,9,9,9h86
                c4.971,0,9-4.029,9-9s-4.029-9-9-9h-15.622v-41.914H263c4.971,0,9-4.029,9-9v-166C272,18.072,267.971,14.043,263,14.043z
                 M254,32.043v110H18v-110H254z M145.378,239.957h-18.756v-41.914h18.756V239.957z M18,180.043v-20h236v20H18z`})),Ye=({className:e="",primary:t="",secondary:a=""})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,d:"M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2zm11 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm-8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"}),n.createElement("path",{className:a,d:"M9.73 14H17a1 1 0 0 1 0 2H9.73a2 2 0 0 0 0-2zm4.54-6a2 2 0 0 0 0 2H7a1 1 0 1 1 0-2h7.27z"})),V=n.forwardRef(({defaultPressed:e,pressed:t,onPressedChange:a,disabled:i,children:r,className:s,toggleClass:o},d)=>{const[c,l]=f.exports.useState(e),h=!!a,g=h?t:c,p=h?a:l,y=o!=null?o:"text-pink-900 bg-pink-500";return n.createElement(be,{className:x("flex items-center justify-center default-ring rounded-full",i&&g&&"text-gray-400 bg-gray-700",g&&"text-gray-200 bg-gray-700",!g&&y,s),pressed:g,onPressedChange:p,disabled:i,ref:d},r)});function Je(){const{ongoingCall:e}=U(),{audio:t,video:a,devices:i}=C(),r=i.filter(c=>c.kind==="videoinput"),s=i.filter(c=>c.kind==="audioinput"),o=c=>{const l=r[parseInt(c.target.value)];a.changeDevice(l,e)},d=c=>{const l=s[parseInt(c.target.value)];t.changeDevice(l,e)};return n.createElement("div",{className:"space-y-6"},n.createElement("div",{className:"VideoInputs"},n.createElement("h2",{className:"font-semibold"},"Camera"),n.createElement("select",{className:"input default-ring bg-gray-200",onChange:o},r.map((c,l)=>n.createElement("option",{key:l,value:l},c.label===""?c.groupId:c.label)))),n.createElement("div",{className:"AudioInputs"},n.createElement("h2",{className:"font-semibold"},"Microphone"),n.createElement("select",{className:"input default-ring bg-gray-200",onChange:d},s.map((c,l)=>n.createElement("option",{key:l,value:l},c.label===""?c.groupId:c.label)))))}const Qe=({className:e})=>{const{push:t}=G(),{audio:a,video:i,sharedScreen:r}=C(d=>({audio:d.audio,video:d.video,sharedScreen:d.sharedScreen})),s=U(d=>d.hangup),o=f.exports.useCallback(()=>{s(),a.tracks.forEach(d=>d.stop()),i.tracks.forEach(d=>d.stop()),t("/")},[]);return n.createElement("div",{className:x("flex justify-center p-3 space-x-3",e)},n.createElement(V,{className:"w-10 h-10",pressed:i.enabled,onPressedChange:i.toggle},n.createElement(We,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Video")),n.createElement(V,{className:"w-10 h-10",pressed:a.enabled,onPressedChange:a.toggle},n.createElement(qe,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Audio")),n.createElement(V,{className:"w-10 h-10",pressed:!r.enabled,onPressedChange:r.toggle,toggleClass:"text-blue-900 bg-blue-500"},n.createElement(Ge,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Screenshare")),n.createElement(ne,null,n.createElement(Fe,{className:"flex justify-center items-center w-10 h-10 text-gray-200 bg-gray-700 rounded-full default-ring"},n.createElement(Ye,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Devices")),n.createElement(ae,{className:"w-full max-w-xl py-8 px-12"},n.createElement(Je,null))),n.createElement("button",{className:"flex justify-center items-center w-10 h-10 text-pink-900 bg-pink-500 rounded-full default-ring",onClick:o},n.createElement(Be,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Hang up")))},Xe=({className:e})=>n.createElement("span",{className:`flex-none inline-block relative ${e}`},n.createElement("span",{className:"block absolute w-full h-full border-2 border-transparent border-t-pink-400 rounded-full animate-spin"}),n.createElement("span",{className:"block relative w-full h-full border border-pink-700 rounded-full"}));function Ze(e){const t=e.srcObject,a=f.exports.useRef(null),i=E(w({},e),{autoPlay:!0,ref:a});return delete i.srcObject,f.exports.useEffect(()=>{!a.current||(a.current.srcObject=t)},[a,t]),n.createElement("video",i,null)}const j=r=>{var s=r,{size:e,className:t,isScreenshare:a}=s,i=I(s,["size","className","isScreenshare"]);const o=a?"rotateY(0deg)":"rotateY(180deg)";return n.createElement("div",{className:x(e==="xs-mini"&&"w-20 sm:w-28 shadow-md rounded-xl",e==="mini"&&"w-32 sm:w-64",e==="large"&&"w-full",t)},n.createElement(Ze,E(w({},i),{className:x("w-full h-full object-cover md:object-contain transform"),style:{transform:o}})))},et=()=>n.createElement(n.Fragment,null,n.createElement("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"},n.createElement("div",{className:"flex items-center mb-2"},n.createElement(Xe,{className:"h-6 w-6 mr-2"}),n.createElement("h2",{className:"font-semibold text-xl text-pink-400"},"Connecting...")),n.createElement("p",{className:"text-gray-300"},"This could take up to a minute."))),tt=({connected:e})=>{var l,h;const{local:t,remote:a,sharedScreen:i,video:r}=C(g=>({local:g.local,remote:g.remote,sharedScreen:g.sharedScreen,video:g.video})),s=((h=(l=r.tracks[0])==null?void 0:l.getSettings())==null?void 0:h.aspectRatio)>1||!0,o=a.getVideoTracks().length>1;console.log("has remote screenshare:"+o),a.getVideoTracks()[0],a.getAudioTracks()[0];var d=null,c=null;if(o){const g=a.getVideoTracks()[1];c=new MediaStream([g])}if(i.enabled){const g=t.getVideoTracks()[1];d=new MediaStream([g])}return n.createElement(n.Fragment,null,n.createElement("div",{className:"relative w-full h-full bg-gray-500 overflow-hidden lg:rounded-xl"},n.createElement("div",{className:"absolute z-10 top-2 left-2 sm:top-6 sm:left-6"},n.createElement(j,{size:s?"mini":"xs-mini",muted:!0,isScreenshare:!1,srcObject:t,className:x("border border-white",s&&"aspect-w-16 aspect-h-9",!s&&"aspect-w-9 aspect-h-16")}),i.enabled&&n.createElement(j,{size:s?"mini":"xs-mini",muted:!0,isScreenshare:!0,srcObject:d,className:x("border border-white",s&&"aspect-w-16 aspect-h-9",!s&&"aspect-w-9 aspect-h-16")})),n.createElement(j,{size:"large",className:"",isScreenshare:!1,srcObject:a,muted:!1}),o&&n.createElement(j,{size:"large",className:"",isScreenshare:!0,controls:!0,srcObject:c,muted:!1}),!e&&et(),n.createElement(Qe,{className:"absolute z-10 bottom-0 left-1/2 transform -translate-x-1/2"})))},nt=({placeCall:e})=>{const{register:t,handleSubmit:a,reset:i,watch:r}=q({mode:"onChange",defaultValues:{ship:""}}),s=r("ship"),o=f.exports.useCallback(({ship:d})=>{!d||(e(Y(d)),i())},[]);return n.createElement("form",{onSubmit:a(o),className:"p-12 bg-gray-200 rounded-xl shadow-xl"},n.createElement("label",{htmlFor:"ship",className:"sr-only"},"Ship"),n.createElement("div",{className:"flex rounded-md focus-within:ring-2 ring-pink-300 focus-within:outline-none"},n.createElement("input",w({id:"ship",type:"text",placeholder:"Ship",className:"flex-1 input min-w-[200px] font-semibold font-mono rounded-r-none focus:outline-none"},t("ship"))),n.createElement("button",{type:"submit",className:"flex-none button px-6 text-pink-900 bg-pink-500 disabled:text-gray-900 disabled:bg-gray-400 disabled:cursor-default rounded-l-none",disabled:!we.isValidPatp(`~${Y(s)}`||"")&&s.length>0},"Call")))};var at="/apps/urchatfm/assets/enter-call.c4287b6d.wav";const st=()=>{const e=f.exports.useCallback(()=>{},[]);return n.createElement(ve,{defaultOpen:!0,onOpenChange:e},n.createElement(Ee,{className:"fixed bottom-4 right-4 inline-block max-w-sm px-8 py-4 space-y-4 bg-gray-100 rounded-xl shadow-lg"},n.createElement("h2",null,"You won't hear incoming calls until you hit this button or interact with the page"),n.createElement(Se,{className:"flex-1 button text-pink-900 bg-pink-500 default-ring"},"Turn On Ringer")))},it=()=>{const e=f.exports.useCallback(t=>t.preventDefault(),[]);return n.createElement(ne,{defaultOpen:!0},n.createElement(ae,{onPointerDownOutside:e,onFocusOutside:e,onInteractOutside:e,showCloseIcon:!1,className:"max-w-lg p-8 text-gray-700"},n.createElement("p",null,"urChatFM is built on top of WebRTC which requires HTTPS to function. You may need to provision a certificate for your Urbit, or you just need to visit the HTTPS version of your site."),n.createElement("div",{className:"flex items-center mt-4 space-x-4"},n.createElement("a",{className:"button text-pink-900 bg-pink-500 default-ring",href:`https://${location.hostname}${location.port&&":"+location.port}${location.pathname}`},"Try HTTPS version of this page"),n.createElement("a",{className:"button text-pink-900 bg-pink-500 default-ring",href:"https://urbit.org/using/os/basics#configuring-ssl"},"Configure SSL certificate"))))};function rt(){const{incomingCall:e,ongoingCall:t,answerCall:a,placeCall:i,rejectCall:r,hangup:s}=U(),{resetStreams:o,getDevices:d}=C(m=>({getDevices:m.getDevices,resetStreams:m.resetStreams})),{push:c}=G(),[l,h]=f.exports.useState(null),[g,p]=f.exports.useState(!1),[y,k]=f.exports.useState([]),z=location.protocol.startsWith("https")||location.hostname==="localhost";f.exports.useEffect(()=>(window.addEventListener("beforeunload",s),()=>window.removeEventListener("beforeunload",s)),[]),f.exports.useEffect(()=>{if(z&&t){const m=new Audio(at);m.volume=.3,m.play(),c(`/chat/${t.conn.uuid}`);const b=()=>d(t);return navigator.mediaDevices.addEventListener("devicechange",b),()=>navigator.mediaDevices.removeEventListener("devicechange",b)}},[t]);const L=f.exports.useCallback(m=>{console.log("Incoming track event",m);const{remote:b}=C.getState();b.addTrack(m.track),console.log("adding on remove callback"),b.onremovetrack=S=>{console.log(`${S.track.kind} track removed`)},C.setState({remote:b})},[]),se=async()=>{o();const m=await a((b,S)=>{p(!1),k([]),S.addEventListener("datachannel",N=>{const D=N.channel;D.onopen=()=>p(!0),D.onmessage=R=>{const _=R.data;k(oe=>[{speaker:b,message:_}].concat(oe)),console.log("channel message",_)},h(D)}),S.ontrack=L});d(m)},ie=async m=>{o();const b=await i(m,S=>{console.log("placing call"),p(!1),k([]);const N=S.createDataChannel("urchatfm");N.onopen=()=>p(!0),N.onmessage=D=>{const R=D.data;k(_=>[{speaker:"~"+m,message:R}].concat(_)),console.log("channel message from ~"+m+": "+R)},h(N),S.ontrack=L});d(b)},re=f.exports.useCallback(m=>{l==null||l.send(m);const b=[{speaker:"me",message:m}].concat(y);console.log(y,b),k(b)},[y,l]);return n.createElement("main",{className:"relative flex flex-col lg:flex-row lg:gap-6 w-full h-full lg:p-8 text-gray-700"},n.createElement("section",{className:"flex-auto lg:flex-1 flex flex-col justify-center h-[50%] lg:h-auto"},n.createElement(J,null,n.createElement(O,{path:"/chat/:id"},n.createElement(tt,{connected:g})),n.createElement(O,{path:"/"},n.createElement("div",{className:"flex justify-center items-center w-full h-full bg-pink-100 rounded-xl"},n.createElement("div",null,n.createElement("h1",{className:"mb-6 mx-12 text-3xl font-semibold font-mono"},"urChatFM"),n.createElement(nt,{placeCall:ie})))))),n.createElement("aside",{className:"flex-auto lg:flex-none lg:w-[33vw] lg:max-w-sm h-[50%] lg:h-auto"},n.createElement(J,null,n.createElement(O,{path:"/chat/:id"},n.createElement(He,{sendMessage:re,messages:y,ready:g})),n.createElement(O,{path:"/"},n.createElement("div",{className:"h-full bg-gray-300 lg:rounded-xl"})))),e&&n.createElement($e,{caller:e.call.peer,answerCall:se,rejectCall:r}),z&&n.createElement(st,null),!z&&n.createElement(it,null))}function ot(){return n.createElement(ye,{basename:"/apps/urchatfm"},n.createElement(rt,null))}xe.render(n.createElement(n.StrictMode,null,n.createElement(ot,null)),document.getElementById("root"));
