var ce=Object.defineProperty,ue=Object.defineProperties;var de=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var G=(e,t,a)=>t in e?ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,w=(e,t)=>{for(var a in t||(t={}))W.call(t,a)&&G(e,a,t[a]);if(P)for(var a of P(t))q.call(t,a)&&G(e,a,t[a]);return e},E=(e,t)=>ue(e,de(t));var I=(e,t)=>{var a={};for(var i in e)W.call(e,i)&&t.indexOf(i)<0&&(a[i]=e[i]);if(e!=null&&P)for(var i of P(e))t.indexOf(i)<0&&q.call(e,i)&&(a[i]=e[i]);return a};import{c as Y,U as he,r as g,R as n,s as me,a as ge,u as J,C as pe,b as fe,d as be,O as we,T as ve,e as Ee,f as x,g as Q,h as L,i as Se,D as xe,j as ye,k as Ce,S as X,l as M,B as ke,m as Ne}from"./vendor.2c4a3ca5.js";const De=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function a(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=a(r);fetch(r.href,s)}};De();var _e=Object.defineProperty,Z=Object.getOwnPropertySymbols,Re=Object.prototype.hasOwnProperty,Te=Object.prototype.propertyIsEnumerable,H=(e,t,a)=>t in e?_e(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,ee=(e,t)=>{for(var a in t||(t={}))Re.call(t,a)&&H(e,a,t[a]);if(Z)for(var a of Z(t))Te.call(t,a)&&H(e,a,t[a]);return e},h=(e,t,a)=>(H(e,typeof t!="symbol"?t+"":t,a),a),Pe=class extends EventTarget{constructor(e,t,a=window.urbit){super();h(this,"_urbit"),h(this,"configuration"),h(this,"dap"),h(this,"subscriptionId"),h(this,"onincomingcall"),h(this,"onhungupcall"),h(this,"onerror"),this._urbit=a,this.configuration=t,this.dap=e,this.onincomingcall=()=>{},this.onhungupcall=()=>{},this.onerror=()=>{},this.subscriptionId=null}initialize(){return this.subscriptionId=this._urbit.subscribe({app:"switchboard",path:`/incoming/${this.dap}`,err:e=>this.onerror(e),event:e=>this.handleIncoming(e),quit:()=>this.initialize()}),this.subscriptionId}handleIncoming(e){e.type=="incoming"?this.incomingCall(e):e.type=="hangup"&&this.hungupCall(e.uuid)}set urbit(e){this._urbit=e,this.initialize()}incomingCall(e){const t=new Ie(e.peer,this.dap,e.uuid,this._urbit,this.configuration);this.onincomingcall(t),this.dispatchEvent(t)}hungupCall(e){const t=new te(e);this.onhungupcall(t),this.dispatchEvent(t)}call(e,t){return new O(e,t,void 0,this._urbit,this.configuration)}},O=class extends RTCPeerConnection{constructor(e,t,a,i,r){super(r);h(this,"urbit"),h(this,"reconnect"),h(this,"peer"),h(this,"dap"),h(this,"uuid"),h(this,"subscriptionId"),h(this,"urbitState"),h(this,"signallingReady"),h(this,"signallingReadyPromise"),h(this,"signallingState"),h(this,"onerror"),h(this,"onurbitstatechanged"),this.urbit=i,this.reconnect=!1,this.peer=e,this.dap=t,this.uuid=a,this.subscriptionId=null,this.onerror=()=>{},this.onurbitstatechanged=()=>{},this.signallingReady=null,this.signallingReadyPromise=new Promise(s=>this.signallingReady=()=>{this.signallingReady=()=>{},s()}),this.onicecandidate=s=>this.signallingState.whenDoneSending(()=>{s.candidate!==null&&this.canTrickleIceCandidates&&this.signallingReadyPromise.then(()=>{var l;this.urbit.verbose&&console.log("Sending ICE candidate for address ${evt.candidate.address}:${evt.candidate.port}"),this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:ee({uuid:this.uuid,tag:"icecandidate"},(l=s.candidate)==null?void 0:l.toJSON())})}).catch(l=>this.closeWithError(l))}),this.onnegotiationneeded=()=>this.renegotiate(),this.urbitState=null,this.signallingState=new Oe}async initialize(){this.reconnect?await this.resubscribe():typeof this.uuid=="undefined"?(this.dispatchUrbitState("dialing"),await this.dial()):(this.dispatchUrbitState("incoming-ringing"),await this.subscribe())}static async reconnect(e){var t=e.uuid,a=e.urbit?e.urbit:window.urbit,i=await a.scry({app:"switchboard",path:`/call/${t}/peer`}),r=await a.scry({app:"switchboard",path:`/call/${t}/dap`}),s=new O(i,r,t,a);return s.reconnect=!0,s}async dial(){await this.urbit.subscribe({app:"switchboard",path:"/uuid",err:e=>this.closeWithError(e),event:e=>this.ring(e),quit:()=>{}})}async ring(e){return this.uuid=e,this.urbit.verbose&&console.log("Call UUID:",this.uuid),await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{uuid:this.uuid,tag:"place-call",peer:this.peer,dap:this.dap}}).catch(t=>this.closeWithError(t)),this.subscribe()}subscribe(){return this.subscriptionId=this.urbit.subscribe({app:"switchboard",path:`/call/${this.uuid}`,err:e=>this.closeWithError(e),event:e=>this.handleFact(e),quit:()=>this.resubscribe()}),this.subscriptionId}async resubscribe(){if(this.connectionState!=="closed"){await this.subscribe();const e=await this.urbit.scry({app:"switchboard",path:`/call/${this.uuid}/last-remote`});e!==null&&(this.signallingState.startSettingRemote(),await this.setRemoteDescription(e.msg),this.signallingState.doneSettingRemote()),this.restartIce()}else throw"Will not resubscribe for closed connection"}close(){var e=new Promise(a=>{super.close(),a()}),t=this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{tag:"reject",uuid:this.uuid}});Promise.all([e,t]).then(()=>{this.subscriptionId!==null&&this.subscriptionId.then(a=>this.urbit.unsubscribe(a))})}remoteHungup(){this.connectionState!="closed"&&(super.close(),super.dispatchEvent(new te(this.uuid||"")))}closeWithError(e){this.close(),console.log("Closed with error",e),this.onerror(e)}async sendSignal(){var e;const t=this.signallingState.waitingType();if(this.urbit.verbose&&console.log("Sending SDP ${signalType}"),this.signallingState.sending(),t==="offer"){const a=await this.createOffer();await this.setLocalDescription(a),this.canTrickleIceCandidates||await this.iceCandidatesGathered()}else{const a=await this.createAnswer();await this.setLocalDescription(a),this.canTrickleIceCandidates||await this.iceCandidatesGathered()}await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:ee({uuid:this.uuid,tag:"sdp"},(e=this.localDescription)==null?void 0:e.toJSON())}),await this.signallingState.doneSending(this.askSignal.bind(this))}async askSignal(){await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{uuid:this.uuid,tag:"ask-signal"}})}async askSendSignal(e){switch(await this.signallingReadyPromise,e){case"offer":this.signallingState.needToMakeOffer();break;case"answer":this.signallingState.gotOffer();break;default:throw"signalType must be offer or answer"}await this.askSignal()}handleFact(e){switch(e.tag){case"connection-state":this.signallingState.whenDoneSettingRemote(()=>this.dispatchUrbitState(e.connectionState));return;case"hungup":this.remoteHungup();return;case"sdp":this.urbit.verbose&&console.log("Got SDP ${fact.type}"),this.signallingState.startSettingRemote(),this.handleSDP(e).then(()=>this.signallingState.doneSettingRemote());return;case"icecandidate":if(this.urbit.verbose){const t=new RTCIceCandidate(e);console.log(`Got ICE candidate with address ${t.address}:${t.port}`)}this.signallingState.whenDoneSettingRemote(()=>{this.addIceCandidate(e)})}}async handleSDP(e){await this.setRemoteDescription(e),e.type==="offer"&&await this.askSendSignal("answer")}dispatchUrbitState(e){switch(this.urbit.verbose&&console.log("Switchboard state",e),e){case"connected-our-turn":case"connected-their-turn":this.signallingReady&&this.signallingReady();break;case"connected-our-turn-asked":this.sendSignal().catch(a=>this.closeWithError(a));break}this.urbitState=e;const t=new Me(this.uuid||"",e);this.dispatchEvent(t),this.onurbitstatechanged(t)}async renegotiate(){await this.askSendSignal("offer")}setConfiguration(e){const t=super.getConfiguration().iceServers;super.setConfiguration(e),e.iceServers!==t&&this.restartIce()}async iceCandidatesGathered(){const e=new AbortController;return new Promise(a=>{this.addEventListener("icegatheringstatechange",()=>{this.iceGatheringState=="complete"&&a()},{signal:e.signal}),this.iceGatheringState=="complete"&&a()}).then(()=>e.abort())}},Ie=class extends Event{constructor(e,t,a,i,r){super("incomingcall");h(this,"type","incomingcall"),h(this,"peer"),h(this,"dap"),h(this,"uuid"),h(this,"urbit"),h(this,"configuration"),this.peer=e,this.dap=t,this.uuid=a,this.urbit=i,this.configuration=r}get call(){return{peer:this.peer,dap:this.dap,uuid:this.uuid}}answer(){return new O(this.peer,this.dap,this.uuid,this.urbit,this.configuration)}async reject(){return this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{tag:"reject",uuid:this.uuid}})}},te=class extends Event{constructor(e){super("hungupcall");h(this,"type","hungupcall"),h(this,"uuid"),this.uuid=e}},Me=class extends Event{constructor(e,t){super("statechanged");h(this,"type","statechanged"),h(this,"uuid"),h(this,"urbitState"),this.uuid=e,this.urbitState=t}},Oe=class extends EventTarget{constructor(){super();h(this,"_state"),h(this,"_settingRemote"),h(this,"_settingRemoteDoneK"),h(this,"_whenDoneSendingK"),this._settingRemote=!1,this._settingRemoteDoneK=()=>{},this._whenDoneSendingK=()=>{},this._state="stable"}startSettingRemote(){this._settingRemote=!0}doneSettingRemote(){this._settingRemote=!1,this._settingRemoteDoneK(),this._settingRemoteDoneK=()=>{}}whenDoneSettingRemote(e){if(this._settingRemote){const t=this._settingRemoteDoneK;this._settingRemoteDoneK=()=>{t(),e()}}else e()}needToMakeOffer(){switch(this._state){case"stable":this._state="waiting-to-send-offer";break;case"sending":this._state="sending-waiting-to-send-offer";break}}gotOffer(){switch(this._state){case"stable":case"waiting-to-send-offer":this._state="waiting-to-send-answer";break;case"waiting-to-send-answer":break;case"sending":case"sending-waiting-to-send-offer":throw"Cannot receive SDP while sending"}}sending(){switch(this._state){case"waiting-to-send-offer":case"waiting-to-send-answer":this._state="sending";break;case"sending":case"sending-waiting-to-send-offer":throw"Cannot send while sending";case"stable":throw"Cannot send with nothing to send"}}doneSending(e){switch(this._state){case"sending":this._state="stable",this._whenDoneSendingK(),this._whenDoneSendingK=()=>{};break;case"sending-waiting-to-send-offer":this._state="waiting-to-send-offer",this._whenDoneSendingK(),this._whenDoneSendingK=()=>{},e();break;default:throw"Cannot be done sending if not sending"}}whenDoneSending(e){switch(this._state){case"stable":e();break;default:const t=this._whenDoneSendingK;this._whenDoneSendingK=()=>{t(),e()}}}waitingType(){switch(this._state){case"waiting-to-send-offer":return"offer";case"waiting-to-send-answer":return"answer";default:throw"Asked for waiting type but not waiting to send anything"}}},ze=Object.defineProperty,je=(e,t,a)=>t in e?ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,v=(e,t,a)=>(je(e,typeof t!="symbol"?t+"":t,a),a),$e=class extends EventTarget{constructor(e=window.urbit){super();v(this,"urbit"),v(this,"iceServers"),v(this,"state"),v(this,"uid"),v(this,"oniceserver"),v(this,"onstatechange"),this.urbit=e,this.iceServers=[],this.state="uninitialized",this.oniceserver=()=>{},this.onstatechange=()=>{},this.uid="";for(let t=0;t<32;t++)this.uid+=Math.floor(Math.random()*16).toString(16)}async initialize(){await this.urbit.subscribe({app:"icepond",path:`/ice-servers/${this.uid}`,err:t=>this.handleError(t),event:t=>this.iceServer(t),quit:()=>this.done()}),this.iceServers=[],this.state="acquiring";const e=new F(this.state);this.dispatchEvent(e),this.onstatechange(e)}handleError(e){console.log("icepond error: ",e),this.state="error";const t=new F(this.state);this.dispatchEvent(t),this.onstatechange(t)}iceServer(e){this.iceServers.includes(e)==!1&&this.iceServers.push(e);const t=new Ae(e,this.iceServers);this.dispatchEvent(t),this.oniceserver(t)}done(){this.state="done";const e=new F(this.state);this.dispatchEvent(e),this.onstatechange(e)}},F=class extends Event{constructor(e){super("statechange");v(this,"state"),this.state=e}},Ae=class extends Event{constructor(e,t){super("iceserver");v(this,"newIceServer"),v(this,"iceServers"),this.newIceServer=e,this.iceServers=t}},Le=$e,He=Object.defineProperty,Fe=(e,t,a)=>t in e?He(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,Ue=(e,t,a)=>(Fe(e,typeof t!="symbol"?t+"":t,a),a),Ve=class extends EventTarget{constructor(e=window.urbit){super();Ue(this,"urbit"),this.urbit=e}async getPals(){return await this.urbit.scry({app:"pals",path:"/json"})}addPal(e,t=[]){this.urbit.poke({app:"pals",mark:"pals-command",json:{meet:{ship:e,in:t}}})}removePal(e){this.urbit.poke({app:"pals",mark:"pals-command",json:{part:{ship:e,in:[]}}})}},Ke=Ve;const ne=!1,U="urchatfm",z=Y((e,t)=>{const a={iceServers:[]},i=new Pe(U,a);i.addEventListener("incomingcall",s=>{t().incomingCall===null?e({incomingCall:s}):s.reject()}),console.log("useMock:"+ne);const r=new he("","");return r.ship=window.ship,i.urbit=r,{urbit:r,icepond:null,pals:null,configuration:{iceServers:[]},urbitRtcApp:i,incomingCall:null,ongoingCall:null,isCaller:!1,setUrbit:s=>{const l=s;t().urbitRtcApp.urbit=l,e({urbit:l})},startIcepond:()=>e(s=>{console.log("attempting icepond");const l=new Le(s.urbit);l.oniceserver=c=>{e(o=>{const u=E(w({},o.configuration),{iceServers:c.iceServers});return console.log("icepond config:"),console.log(u),o.urbitRtcApp!==null&&(o.urbitRtcApp.configuration=u),o.incomingCall!==null&&(o.incomingCall.configuration=u),o.ongoingCall!==null&&o.ongoingCall.conn.setConfiguration(u),E(w({},o),{configuration:u})},!0)},l.initialize(),e({icepond:l})}),startPals:()=>e(s=>{console.log("initializing Pals");const l=new Ke(s.urbit);e({pals:l})}),placeCall:async(s,l)=>{const{urbitRtcApp:c,hungup:o,startIcepond:u}=t();console.log("placeCall");const d=c.call(s,U);l(d),d.addEventListener("hungupcall",o),await d.initialize();const m={peer:s,dap:U,uuid:d.uuid};u();const f={conn:d,call:m};return e({isCaller:!0,ongoingCall:f}),f},answerCall:async s=>{const{incomingCall:l,hungup:c,startIcepond:o}=t(),u=l.call,d=l.answer();d.addEventListener("hungupcall",c),s(u.peer,d),await d.initialize(),o();const m={conn:d,call:u};return e({isCaller:!1,ongoingCall:m,incomingCall:null}),m},reconnectCall:async(s,l)=>{const c=t().urbit,o=await O.reconnect({urbit:c,uuid:s}),u={uuid:s,peer:o.peer,dap:o.dap},d={call:u,conn:o},{hungup:m,startIcepond:f}=t();return o.addEventListener("hungupcall",m),l(u.peer,o),await o.initialize(),f(),e({ongoingCall:d}),d},rejectCall:()=>e(s=>(s.incomingCall.reject(),{incomingCall:null})),hangup:()=>e(s=>(s.ongoingCall&&s.ongoingCall.conn.close(),E(w({},s),{ongoingCall:null}))),hungup:()=>e({ongoingCall:null})}});var Be="/apps/urchatfm/assets/ring.b27464db.wav";const We=e=>n.createElement(n.Fragment,null,me({patp:e.patp,renderer:ge,size:64,colors:["black","white"]})),qe=({caller:e,answerCall:t,rejectCall:a})=>(g.exports.useEffect(()=>{new Audio(Be).play()},[]),n.createElement("div",{className:"fixed top-4 right-4 gap-x-3 flex inline-block px-8 py-4 bg-gray-100 rounded-xl shadow-lg"},n.createElement("div",{className:"flex-1"},n.createElement(We,{patp:e})),n.createElement("div",{className:"flex-1"},n.createElement("h2",null,"Call from ~",n.createElement("span",{className:"font-mono font-semibold"},e)),n.createElement("div",{className:"flex space-x-3"},n.createElement("button",{className:"flex-1 button text-green-900 bg-green-500",onClick:t},"Answer"),n.createElement("button",{className:"flex-1 button text-red-900 bg-red-500",onClick:a},"Reject"))))),Ge=({sendMessage:e,messages:t,ready:a})=>{const{register:i,handleSubmit:r,reset:s}=J({defaultValues:{message:""}}),l=!a&&!ne,c=g.exports.useCallback(({message:o})=>{console.log(o),e(o),s()},[e]);return n.createElement("div",{className:`flex flex-col h-full p-3 sm:p-6 text-sm bg-pink-100 lg:rounded-xl overflow-hidden ${l?"opacity-50":""}`},n.createElement("div",{className:"flex-1 h-full px-4 py-3 bg-white rounded-md overflow-y-auto"},n.createElement("div",{className:"flex flex-col-reverse justify-start"},t.map((o,u)=>n.createElement("div",{className:"mt-4",key:u},n.createElement("span",{className:"font-bold mr-3"},o.speaker,":"),o.message)))),n.createElement("form",{className:"flex-none flex mt-3 sm:mt-6 relative rounded-md focus-within:ring-2 ring-pink-300 focus-within:outline-none",onSubmit:r(c)},n.createElement("label",{htmlFor:"message",className:"sr-only"},"Send a Message:"),n.createElement("input",E(w({id:"message",type:"text",className:"flex-1 input rounded-r-none focus:outline-none"},i("message")),{disabled:l})),n.createElement("button",{type:"submit",disabled:l,className:"flex-none button px-6 text-pink-900 bg-pink-500 rounded-l-none"},"Send")))},y=Y((e,t)=>({local:new MediaStream,remote:new MediaStream,video:{enabled:!0,device:null,tracks:[],changeDevice:(a,i)=>j(a,"video",t(),i),toggle:()=>{e({video:ae(t().video)})}},audio:{enabled:!0,device:null,tracks:[],changeDevice:(a,i)=>j(a,"audio",t(),i),toggle:()=>{e({audio:ae(t().audio)})}},sharedScreen:{enabled:!1,tracks:[],toggle:async()=>{var a=t().sharedScreen;a.enabled?e({sharedScreen:await Qe(t())}):e({sharedScreen:await Je(t())})}},devices:[],resetStreams:()=>{e({local:new MediaStream,remote:new MediaStream})},call:null,getDevices:async a=>{var o;const i=await((o=navigator.mediaDevices)==null?void 0:o.enumerateDevices()),r=i.filter(u=>u.kind==="videoinput"),s=i.filter(u=>u.kind==="audioinput"),l=await j(r[0],"video",t(),a),c=await j(s[0],"audio",t(),a);e({devices:i,video:l,audio:c}),e({call:a})}}));function ae(e){return e.enabled=!e.enabled,e.tracks.forEach(t=>{t.enabled=e.enabled}),e}const Ye={video:{facingMode:"user",width:1280,height:719},audio:null};async function Je(e){console.log("start share screen");const t=e.sharedScreen,a=e.call,i=r=>{var l;r.onended=c=>{console.log(`${c} ON ENDED`)},console.log("Adding screenshare track to call",r),r.contentHint="screenshare",e.local.addTrack(r);const s=(l=a.conn)==null?void 0:l.addTrack(r);return r.sender=s,r};return t.tracks=(await navigator.mediaDevices.getDisplayMedia()).getTracks().map(i),t.enabled=!0,t}async function Qe(e){console.log("stop share screen");const t=e.sharedScreen,a=e.call,i=r=>{var s;console.log("Removing screenshare track from call",r),e.local.removeTrack(r);try{(s=a.conn)==null||s.removeTrack(r.sender)}catch(l){console.log(l)}r.stop()};return t.tracks.forEach(i),t.enabled=!1,t}async function j(e,t,a,i){var u;const r=a[t],s=d=>{var f;console.log("Adding track to call",d),a.local.addTrack(d);const m=(f=i.conn)==null?void 0:f.addTrack(d);return d.sender=m,d},l=d=>{var m;console.log("Removing track from call",d),a.local.removeTrack(d);try{(m=i.conn)==null||m.removeTrack(d.sender)}catch(f){console.log(f)}d.stop()},c={[t]:w({deviceId:e.deviceId},Ye[t])},o=await((u=navigator.mediaDevices)==null?void 0:u.getUserMedia(c));return r.tracks.forEach(l),t==="audio"?r.tracks=o.getAudioTracks().map(s):t==="video"&&(r.tracks=o.getVideoTracks().map(s)),r.device=e,r}const Xe=({className:e="",primary:t=""})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,fillRule:"evenodd",d:"M15.78 14.36a1 1 0 0 1-1.42 1.42l-2.82-2.83-2.83 2.83a1 1 0 1 1-1.42-1.42l2.83-2.82L7.3 8.7a1 1 0 0 1 1.42-1.42l2.83 2.83 2.82-2.83a1 1 0 0 1 1.42 1.42l-2.83 2.83 2.83 2.82z"})),se=a=>{var i=a,{children:e}=i,t=I(i,["children"]);return n.createElement(be,w({},t),n.createElement(we,{className:"fixed z-10 top-0 left-0 right-0 bottom-0 dark:bg-white bg-black opacity-30"}),e)},ie=n.forwardRef((s,r)=>{var l=s,{children:e,showCloseIcon:t=!0,className:a="p-6"}=l,i=I(l,["children","showCloseIcon","className"]);return n.createElement(pe,E(w({className:"fixed z-40 top-1/2 left-1/2 bg-gray-100 rounded-xl default-ring transform -translate-y-1/2 -translate-x-1/2"},i),{ref:r}),n.createElement("div",{className:`relative ${a}`},e,t&&n.createElement(fe,{className:"absolute top-2 right-2 text-gray-300 dark:text-gray-700 hover:text-gray-400 dark:hover:text-gray-500 focus:text-gray-400 dark:focus:text-gray-500 default-ring rounded"},n.createElement(Xe,{className:"w-7 h-7",primary:"fill-current"}))))}),Ze=ve,et=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:a,d:"M13.59 12l6.7-6.7A1 1 0 0 1 22 6v12a1 1 0 0 1-1.7.7L13.58 12z"}),n.createElement("rect",{width:"14",height:"14",x:"2",y:"5",className:t,rx:"2"})),tt=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,d:"M11 4h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V6h-2v12h2v-2a1 1 0 0 1 2 0v3a1 1 0 0 1-1 1h-3v1a1 1 0 0 1-1.27.96l-6.98-2A1 1 0 0 1 2 19V5a1 1 0 0 1 .75-.97l6.98-2A1 1 0 0 1 11 3v1z"}),n.createElement("path",{className:a,d:"M18.59 11l-1.3-1.3c-.94-.94.47-2.35 1.42-1.4l3 3a1 1 0 0 1 0 1.4l-3 3c-.95.95-2.36-.46-1.42-1.4l1.3-1.3H14a1 1 0 0 1 0-2h4.59z"})),nt=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:a,d:"M12 1a4 4 0 0 1 4 4v6a4 4 0 1 1-8 0V5a4 4 0 0 1 4-4z"}),n.createElement("path",{className:t,d:"M13 18.94V21h3a1 1 0 0 1 0 2H8a1 1 0 0 1 0-2h3v-2.06A8 8 0 0 1 4 11a1 1 0 0 1 2 0 6 6 0 1 0 12 0 1 1 0 0 1 2 0 8 8 0 0 1-7 7.94z"})),at=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 272 272",className:e},n.createElement("path",{className:t,d:`M263,14.043H9c-4.971,0-9,4.029-9,9v166c0,4.971,4.029,9,9,9h99.622v41.914H93c-4.971,0-9,4.029-9,9s4.029,9,9,9h86
                c4.971,0,9-4.029,9-9s-4.029-9-9-9h-15.622v-41.914H263c4.971,0,9-4.029,9-9v-166C272,18.072,267.971,14.043,263,14.043z
                 M254,32.043v110H18v-110H254z M145.378,239.957h-18.756v-41.914h18.756V239.957z M18,180.043v-20h236v20H18z`})),st=({className:e="",primary:t="",secondary:a=""})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,d:"M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2zm11 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm-8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"}),n.createElement("path",{className:a,d:"M9.73 14H17a1 1 0 0 1 0 2H9.73a2 2 0 0 0 0-2zm4.54-6a2 2 0 0 0 0 2H7a1 1 0 1 1 0-2h7.27z"})),V=n.forwardRef(({defaultPressed:e,pressed:t,onPressedChange:a,disabled:i,children:r,className:s,toggleClass:l},c)=>{const[o,u]=g.exports.useState(e),d=!!a,m=d?t:o,f=d?a:u,S=l!=null?l:"text-pink-900 bg-pink-500";return n.createElement(Ee,{className:x("flex items-center justify-center default-ring rounded-full",i&&m&&"text-gray-400 bg-gray-700",m&&"text-gray-200 bg-gray-700",!m&&S,s),pressed:m,onPressedChange:f,disabled:i,ref:c},r)});function it(){const{ongoingCall:e}=z(),{audio:t,video:a,devices:i}=y(),r=i.filter(o=>o.kind==="videoinput"),s=i.filter(o=>o.kind==="audioinput"),l=o=>{const u=r[parseInt(o.target.value)];a.changeDevice(u,e)},c=o=>{const u=s[parseInt(o.target.value)];t.changeDevice(u,e)};return n.createElement("div",{className:"space-y-6"},n.createElement("div",{className:"VideoInputs"},n.createElement("h2",{className:"font-semibold"},"Camera"),n.createElement("select",{className:"input default-ring bg-gray-200",onChange:l},r.map((o,u)=>n.createElement("option",{key:u,value:u},o.label===""?o.groupId:o.label)))),n.createElement("div",{className:"AudioInputs"},n.createElement("h2",{className:"font-semibold"},"Microphone"),n.createElement("select",{className:"input default-ring bg-gray-200",onChange:c},s.map((o,u)=>n.createElement("option",{key:u,value:u},o.label===""?o.groupId:o.label)))))}const rt=({className:e})=>{const{push:t}=Q(),{audio:a,video:i,sharedScreen:r}=y(c=>({audio:c.audio,video:c.video,sharedScreen:c.sharedScreen})),s=z(c=>c.hangup),l=g.exports.useCallback(()=>{s(),a.tracks.forEach(c=>c.stop()),i.tracks.forEach(c=>c.stop()),t("/")},[]);return n.createElement("div",{className:x("flex justify-center p-3 space-x-3",e)},n.createElement(V,{className:"w-10 h-10",pressed:i.enabled,onPressedChange:i.toggle},n.createElement(et,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Video")),n.createElement(V,{className:"w-10 h-10",pressed:a.enabled,onPressedChange:a.toggle},n.createElement(nt,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Audio")),n.createElement(V,{className:"w-10 h-10",pressed:!r.enabled,onPressedChange:r.toggle,toggleClass:"text-blue-900 bg-blue-500"},n.createElement(at,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Screenshare")),n.createElement(se,null,n.createElement(Ze,{className:"flex justify-center items-center w-10 h-10 text-gray-200 bg-gray-700 rounded-full default-ring"},n.createElement(st,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Devices")),n.createElement(ie,{className:"w-full max-w-xl py-8 px-12"},n.createElement(it,null))),n.createElement("button",{className:"flex justify-center items-center w-10 h-10 text-pink-900 bg-pink-500 rounded-full default-ring",onClick:l},n.createElement(tt,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Hang up")))},lt=({className:e})=>n.createElement("span",{className:`flex-none inline-block relative ${e}`},n.createElement("span",{className:"block absolute w-full h-full border-2 border-transparent border-t-pink-400 rounded-full animate-spin"}),n.createElement("span",{className:"block relative w-full h-full border border-pink-700 rounded-full"}));function ot(e){const t=e.srcObject,a=g.exports.useRef(null),i=E(w({},e),{autoPlay:!0,ref:a});return delete i.srcObject,g.exports.useEffect(()=>{!a.current||(a.current.srcObject=t)},[a,t]),n.createElement("video",i,null)}const $=r=>{var s=r,{size:e,className:t,isScreenshare:a}=s,i=I(s,["size","className","isScreenshare"]);const l=a?"rotateY(0deg)":"rotateY(180deg)";return n.createElement("div",{className:x(e==="xs-mini"&&"w-20 sm:w-28 shadow-md rounded-xl",e==="mini"&&"w-32 sm:w-64",e==="large"&&"h-1",t)},n.createElement(ot,E(w({},i),{className:x("h-full w-full object-cover md:object-contain"),style:{transform:l}})))},ct=()=>n.createElement(n.Fragment,null,n.createElement("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"},n.createElement("div",{className:"flex items-center mb-2"},n.createElement(lt,{className:"h-6 w-6 mr-2"}),n.createElement("h2",{className:"font-semibold text-xl text-pink-400"},"Connecting...")),n.createElement("p",{className:"text-gray-300"},"This could take up to a minute."))),ut=({connected:e})=>{var u,d;const{local:t,remote:a,sharedScreen:i,video:r}=y(m=>({local:m.local,remote:m.remote,sharedScreen:m.sharedScreen,video:m.video})),s=((d=(u=r.tracks[0])==null?void 0:u.getSettings())==null?void 0:d.aspectRatio)>1||!0,l=a.getVideoTracks().length>1;var c=null,o=null;if(l){const m=a.getVideoTracks()[1];o=new MediaStream([m])}if(i.enabled){const m=t.getVideoTracks()[1];c=new MediaStream([m])}return n.createElement(n.Fragment,null,n.createElement("div",{className:"relative w-full h-full bg-gray-500 overflow-hidden lg:rounded-xl"},n.createElement("div",{className:"absolute z-10 top-2 left-2 sm:top-6 sm:left-6"},n.createElement($,{size:s?"mini":"xs-mini",muted:!0,isScreenshare:!1,srcObject:t,className:x("border border-white",s&&"aspect-w-16 aspect-h-9",!s&&"aspect-w-9 aspect-h-16")}),i.enabled&&n.createElement($,{size:s?"mini":"xs-mini",muted:!0,isScreenshare:!0,srcObject:c,className:x("border border-white",s&&"aspect-w-16 aspect-h-9",!s&&"aspect-w-9 aspect-h-16")})),n.createElement("div",{id:"remotevideos",className:"h-full w-full flex flex-col"},n.createElement($,{size:"large",className:"flex-1",isScreenshare:!1,srcObject:a,muted:!1}),l&&n.createElement($,{size:"large",className:"flex-1",isScreenshare:!0,controls:!0,srcObject:o,muted:!1})),!e&&ct(),n.createElement(rt,{className:"absolute z-10 bottom-0 left-1/2 transform -translate-x-1/2"})))},dt=({placeCall:e})=>{const{register:t,handleSubmit:a,reset:i,watch:r}=J({mode:"onChange",defaultValues:{ship:""}}),s=r("ship"),l=g.exports.useCallback(({ship:c})=>{!c||(e(L(c)),i())},[]);return n.createElement("form",{onSubmit:a(l),className:"p-12 bg-gray-200 rounded-xl shadow-xl"},n.createElement("label",{htmlFor:"ship",className:"sr-only"},"Ship"),n.createElement("div",{className:"flex rounded-md focus-within:ring-2 ring-pink-300 focus-within:outline-none"},n.createElement("input",w({id:"ship",type:"text",placeholder:"Ship",className:"flex-1 input min-w-[200px] font-semibold font-mono rounded-r-none focus:outline-none"},t("ship"))),n.createElement("button",{type:"submit",className:"flex-none button px-6 text-pink-900 bg-pink-500 disabled:text-gray-900 disabled:bg-gray-400 disabled:cursor-default rounded-l-none",disabled:!Se.isValidPatp(`~${L(s)}`||"")&&s.length>0},"Call")))};var ht="/apps/urchatfm/assets/enter-call.c4287b6d.wav";const mt=()=>{const e=g.exports.useCallback(()=>{},[]);return n.createElement(xe,{defaultOpen:!0,onOpenChange:e},n.createElement(ye,{className:"fixed bottom-4 right-4 inline-block max-w-sm px-8 py-4 space-y-4 bg-gray-100 rounded-xl shadow-lg"},n.createElement("h2",null,"You won't hear incoming calls until you hit this button or interact with the page"),n.createElement(Ce,{className:"flex-1 button text-pink-900 bg-pink-500 default-ring"},"Turn On Ringer")))},gt=()=>{const e=g.exports.useCallback(t=>t.preventDefault(),[]);return n.createElement(se,{defaultOpen:!0},n.createElement(ie,{onPointerDownOutside:e,onFocusOutside:e,onInteractOutside:e,showCloseIcon:!1,className:"max-w-lg p-8 text-gray-700"},n.createElement("p",null,"urChatFM is built on top of WebRTC which requires HTTPS to function. You may need to provision a certificate for your Urbit, or you just need to visit the HTTPS version of your site."),n.createElement("div",{className:"flex items-center mt-4 space-x-4"},n.createElement("a",{className:"button text-pink-900 bg-pink-500 default-ring",href:`https://${location.hostname}${location.port&&":"+location.port}${location.pathname}`},"Try HTTPS version of this page"),n.createElement("a",{className:"button text-pink-900 bg-pink-500 default-ring",href:"https://urbit.org/using/os/basics#configuring-ssl"},"Configure SSL certificate"))))},pt=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",className:e,viewBox:"0 0 46.282 46.283"},n.createElement("path",{className:a,d:"M44.676,3.031c-2.138-2.137-5.598-2.141-7.74-0.016c-2.143-2.125-5.604-2.121-7.742,0.016    c-2.142,2.14-2.142,5.614,0,7.755c0.104,0.105,5.187,5.162,7.059,7.024c0.378,0.377,0.989,0.377,1.364,0    c1.871-1.862,6.953-6.919,7.061-7.024C46.817,8.646,46.817,5.17,44.676,3.031z"}),n.createElement("path",{className:t,d:"M33.313,28.456c-0.94-2.821-3.588-4.724-6.562-4.724h-0.617l-0.852,0.59c-0.882,0.613-1.913,0.938-2.986,0.938    c-1.398,0-2.726-0.566-3.697-1.527h-0.873l-5.377,3.74c0.624,1.07,0.845,2.314,0.624,3.547c-0.247,1.377-1.015,2.574-2.162,3.371    l-2.164,1.5c-0.053,0.344-0.09,0.69-0.09,1.039v3.881c0,2.24,1.838,4.047,4.079,4.047h19.062c2.241,0,4.082-1.807,4.082-4.047    v-3.881c0-0.742-0.132-1.48-0.365-2.186L33.313,28.456z M22.17,42.5c-3.847,0-6.975-3.128-6.975-6.975    c0-3.846,3.128-6.975,6.975-6.975c3.845,0,6.973,3.129,6.973,6.975C29.142,39.372,26.014,42.5,22.17,42.5z"}),n.createElement("path",{className:t,d:"M22.17,31.57c-2.181,0-3.954,1.773-3.954,3.955c0,2.181,1.773,3.955,3.954,3.955c2.18,0,3.953-1.774,3.953-3.955    C26.123,33.343,24.349,31.57,22.17,31.57z"}),n.createElement("path",{className:t,d:"M9.639,28.832l-0.215-0.309c-0.698-1.004-0.451-2.383,0.553-3.082l7.206-5.016c0.374-0.26,0.815-0.396,1.265-0.396    c0.13,0,0.261,0.011,0.391,0.034c0.578,0.104,1.091,0.433,1.427,0.916l0.214,0.308c0.43,0.617,1.119,0.948,1.818,0.948    c0.438,0,0.878-0.128,1.263-0.396l4.25-2.958c0.483-0.335,0.812-0.848,0.916-1.427c0.104-0.576-0.027-1.172-0.363-1.656    c-1.902-2.734-4.949-4.199-8.045-4.199c-1.931-0.001-3.881,0.569-5.585,1.756l-10.534,7.33c-4.438,3.089-5.533,9.192-2.442,13.632    c0.336,0.481,0.848,0.812,1.425,0.914c0.13,0.023,0.26,0.035,0.39,0.035c0.449,0,0.892-0.137,1.266-0.396l4.251-2.959    C10.09,31.213,10.338,29.834,9.639,28.832z"})),ft=({placeCall:e,ship:t})=>{const a=()=>{e(t)};return n.createElement(n.Fragment,null,n.createElement("div",{className:"flex flex-row w-full mt-3 h-10 bg-blue-100 rounded-lg"},n.createElement("h1",{className:"text-xl font-semibold w-1/2 text-center font-mono my-auto"},t),n.createElement("button",{className:"h-5/6 flex flex-row my-auto flex-1",type:"submit",onClick:a},n.createElement("p",{className:"my-auto"},"Call Them"),n.createElement(pt,{className:"h-full mx-1",secondary:"text-pink-900 bg-pink-500 fill-current"}))))},bt=({placeCall:e})=>{const{startPals:t,pals:a}=z(),[i,r]=g.exports.useState(["~bus","~zod"]),s=c=>{e(L(c))};g.exports.useEffect(()=>{t()},[]);const l=async()=>{const c=await a.getPals(),o=c.incoming,u=c.outgoing,d=Object.keys(u).filter(m=>m in o);r(d)};return n.createElement(n.Fragment,null,n.createElement("div",{className:"w-full p-2"},n.createElement("div",{className:"flex flex-row"},n.createElement("h1",{className:"text-3xl font-semibold font-mono"},"%pals"),n.createElement("button",{type:"submit",onClick:l,className:"button bg-blue-200 flex-1"},"Refresh mutuals list")),i.map(c=>n.createElement(ft,{key:c,ship:c,placeCall:s}))))};function wt(){const{incomingCall:e,ongoingCall:t,answerCall:a,placeCall:i,rejectCall:r,startPals:s,hangup:l}=z(),{resetStreams:c,getDevices:o}=y(p=>({getDevices:p.getDevices,resetStreams:p.resetStreams})),{push:u}=Q(),[d,m]=g.exports.useState(null),[f,S]=g.exports.useState(!1),[_,C]=g.exports.useState([]),A=location.protocol.startsWith("https")||location.hostname==="localhost";g.exports.useEffect(()=>(console.log("initialize pals"),s(),window.addEventListener("beforeunload",l),()=>window.removeEventListener("beforeunload",l)),[]),g.exports.useEffect(()=>{if(A&&t){const p=new Audio(ht);p.volume=.3,p.play(),u(`/chat/${t.conn.uuid}`);const b=()=>o(t);return navigator.mediaDevices.addEventListener("devicechange",b),()=>navigator.mediaDevices.removeEventListener("devicechange",b)}},[t]);const K=g.exports.useCallback(p=>{console.log("Incoming track event",p);const{remote:b}=y.getState();b.addTrack(p.track),y.setState({remote:b})},[]),re=async()=>{c();const p=await a((b,k)=>{S(!1),C([]),k.addEventListener("datachannel",N=>{const D=N.channel;D.onopen=()=>S(!0),D.onmessage=R=>{const T=R.data;C(oe=>[{speaker:b,message:T}].concat(oe)),console.log("channel message",T)},m(D)}),k.ontrack=K});o(p)},B=async p=>{c();const b=await i(p,k=>{console.log("placing call"),S(!1),C([]);const N=k.createDataChannel("urchatfm");N.onopen=()=>S(!0),N.onmessage=D=>{const R=D.data;C(T=>[{speaker:"~"+p,message:R}].concat(T)),console.log("channel message from ~"+p+": "+R)},m(N),k.ontrack=K});o(b)},le=g.exports.useCallback(p=>{d==null||d.send(p);const b=[{speaker:"me",message:p}].concat(_);console.log(_,b),C(b)},[_,d]);return n.createElement("main",{className:"relative flex flex-col lg:flex-row lg:gap-6 w-full h-full lg:p-8 text-gray-700"},n.createElement("section",{className:"flex-auto lg:flex-1 flex flex-col justify-center h-[50%] lg:h-auto"},n.createElement(X,null,n.createElement(M,{path:"/chat/:id"},n.createElement(ut,{connected:f})),n.createElement(M,{path:"/"},n.createElement("div",{className:"flex justify-center items-center w-full h-full bg-pink-100 rounded-xl"},n.createElement("div",null,n.createElement("h1",{className:"mb-6 mx-12 text-3xl font-semibold font-mono"},"urChatFM"),n.createElement(dt,{placeCall:B})))))),n.createElement("aside",{className:"flex-auto lg:flex-none lg:w-[33vw] lg:max-w-sm h-[50%] lg:h-auto"},n.createElement(X,null,n.createElement(M,{path:"/chat/:id"},n.createElement(Ge,{sendMessage:le,messages:_,ready:f})),n.createElement(M,{path:"/"},n.createElement("div",{className:"h-full bg-gray-300 lg:rounded-xl"},n.createElement(bt,{placeCall:B}))))),e&&n.createElement(qe,{caller:e.call.peer,answerCall:re,rejectCall:r}),A&&n.createElement(mt,null),!A&&n.createElement(gt,null))}function vt(){return n.createElement(ke,{basename:"/apps/urchatfm"},n.createElement(wt,null))}Ne.render(n.createElement(n.StrictMode,null,n.createElement(vt,null)),document.getElementById("root"));
