var le=Object.defineProperty,ce=Object.defineProperties;var ue=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var F=(e,t,a)=>t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,w=(e,t)=>{for(var a in t||(t={}))K.call(t,a)&&F(e,a,t[a]);if(I)for(var a of I(t))V.call(t,a)&&F(e,a,t[a]);return e},E=(e,t)=>ce(e,ue(t));var T=(e,t)=>{var a={};for(var i in e)K.call(e,i)&&t.indexOf(i)<0&&(a[i]=e[i]);if(e!=null&&I)for(var i of I(e))t.indexOf(i)<0&&V.call(e,i)&&(a[i]=e[i]);return a};import{c as W,U as de,r as p,R as n,u as B,C as he,a as ge,b as me,O as pe,T as fe,d as be,e as k,f as q,g as G,s as we,D as ve,h as Ee,i as ye,S as Y,j as O,B as Se,k as xe}from"./vendor.2ba24969.js";const Ce=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function a(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=a(r);fetch(r.href,s)}};Ce();var ke=Object.defineProperty,J=Object.getOwnPropertySymbols,Ne=Object.prototype.hasOwnProperty,De=Object.prototype.propertyIsEnumerable,A=(e,t,a)=>t in e?ke(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,Q=(e,t)=>{for(var a in t||(t={}))Ne.call(t,a)&&A(e,a,t[a]);if(J)for(var a of J(t))De.call(t,a)&&A(e,a,t[a]);return e},u=(e,t,a)=>(A(e,typeof t!="symbol"?t+"":t,a),a),Re=class extends EventTarget{constructor(e,t,a=window.urbit){super();u(this,"_urbit"),u(this,"configuration"),u(this,"dap"),u(this,"subscriptionId"),u(this,"onincomingcall"),u(this,"onhungupcall"),u(this,"onerror"),this._urbit=a,this.configuration=t,this.dap=e,this.onincomingcall=()=>{},this.onhungupcall=()=>{},this.onerror=()=>{},this.subscriptionId=null}initialize(){return this.subscriptionId=this._urbit.subscribe({app:"switchboard",path:`/incoming/${this.dap}`,err:e=>this.onerror(e),event:e=>this.handleIncoming(e),quit:()=>this.initialize()}),this.subscriptionId}handleIncoming(e){e.type=="incoming"?this.incomingCall(e):e.type=="hangup"&&this.hungupCall(e.uuid)}set urbit(e){this._urbit=e,this.initialize()}incomingCall(e){const t=new _e(e.peer,this.dap,e.uuid,this._urbit,this.configuration);this.onincomingcall(t),this.dispatchEvent(t)}hungupCall(e){const t=new X(e);this.onhungupcall(t),this.dispatchEvent(t)}call(e,t){return new P(e,t,void 0,this._urbit,this.configuration)}},P=class extends RTCPeerConnection{constructor(e,t,a,i,r){super(r);u(this,"urbit"),u(this,"reconnect"),u(this,"peer"),u(this,"dap"),u(this,"uuid"),u(this,"subscriptionId"),u(this,"urbitState"),u(this,"signallingReady"),u(this,"signallingReadyPromise"),u(this,"signallingState"),u(this,"onerror"),u(this,"onurbitstatechanged"),this.urbit=i,this.reconnect=!1,this.peer=e,this.dap=t,this.uuid=a,this.subscriptionId=null,this.onerror=()=>{},this.onurbitstatechanged=()=>{},this.signallingReady=null,this.signallingReadyPromise=new Promise(s=>this.signallingReady=()=>{this.signallingReady=()=>{},s()}),this.onicecandidate=s=>this.signallingState.whenDoneSending(()=>{s.candidate!==null&&this.canTrickleIceCandidates&&this.signallingReadyPromise.then(()=>{var o;this.urbit.verbose&&console.log("Sending ICE candidate for address ${evt.candidate.address}:${evt.candidate.port}"),this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:Q({uuid:this.uuid,tag:"icecandidate"},(o=s.candidate)==null?void 0:o.toJSON())})}).catch(o=>this.closeWithError(o))}),this.onnegotiationneeded=()=>this.renegotiate(),this.urbitState=null,this.signallingState=new Te}async initialize(){this.reconnect?await this.resubscribe():typeof this.uuid=="undefined"?(this.dispatchUrbitState("dialing"),await this.dial()):(this.dispatchUrbitState("incoming-ringing"),await this.subscribe())}static async reconnect(e){var t=e.uuid,a=e.urbit?e.urbit:window.urbit,i=await a.scry({app:"switchboard",path:`/call/${t}/peer`}),r=await a.scry({app:"switchboard",path:`/call/${t}/dap`}),s=new P(i,r,t,a);return s.reconnect=!0,s}async dial(){await this.urbit.subscribe({app:"switchboard",path:"/uuid",err:e=>this.closeWithError(e),event:e=>this.ring(e),quit:()=>{}})}async ring(e){return this.uuid=e,this.urbit.verbose&&console.log("Call UUID:",this.uuid),await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{uuid:this.uuid,tag:"place-call",peer:this.peer,dap:this.dap}}).catch(t=>this.closeWithError(t)),this.subscribe()}subscribe(){return this.subscriptionId=this.urbit.subscribe({app:"switchboard",path:`/call/${this.uuid}`,err:e=>this.closeWithError(e),event:e=>this.handleFact(e),quit:()=>this.resubscribe()}),this.subscriptionId}async resubscribe(){if(this.connectionState!=="closed"){await this.subscribe();const e=await this.urbit.scry({app:"switchboard",path:`/call/${this.uuid}/last-remote`});e!==null&&(this.signallingState.startSettingRemote(),await this.setRemoteDescription(e.msg),this.signallingState.doneSettingRemote()),this.restartIce()}else throw"Will not resubscribe for closed connection"}close(){var e=new Promise(a=>{super.close(),a()}),t=this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{tag:"reject",uuid:this.uuid}});Promise.all([e,t]).then(()=>{this.subscriptionId!==null&&this.subscriptionId.then(a=>this.urbit.unsubscribe(a))})}remoteHungup(){this.connectionState!="closed"&&(super.close(),super.dispatchEvent(new X(this.uuid||"")))}closeWithError(e){this.close(),console.log("Closed with error",e),this.onerror(e)}async sendSignal(){var e;const t=this.signallingState.waitingType();if(this.urbit.verbose&&console.log("Sending SDP ${signalType}"),this.signallingState.sending(),t==="offer"){const a=await this.createOffer();await this.setLocalDescription(a),this.canTrickleIceCandidates||await this.iceCandidatesGathered()}else{const a=await this.createAnswer();await this.setLocalDescription(a),this.canTrickleIceCandidates||await this.iceCandidatesGathered()}await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:Q({uuid:this.uuid,tag:"sdp"},(e=this.localDescription)==null?void 0:e.toJSON())}),await this.signallingState.doneSending(this.askSignal.bind(this))}async askSignal(){await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{uuid:this.uuid,tag:"ask-signal"}})}async askSendSignal(e){switch(await this.signallingReadyPromise,e){case"offer":this.signallingState.needToMakeOffer();break;case"answer":this.signallingState.gotOffer();break;default:throw"signalType must be offer or answer"}await this.askSignal()}handleFact(e){switch(e.tag){case"connection-state":this.signallingState.whenDoneSettingRemote(()=>this.dispatchUrbitState(e.connectionState));return;case"hungup":this.remoteHungup();return;case"sdp":this.urbit.verbose&&console.log("Got SDP ${fact.type}"),this.signallingState.startSettingRemote(),this.handleSDP(e).then(()=>this.signallingState.doneSettingRemote());return;case"icecandidate":if(this.urbit.verbose){const t=new RTCIceCandidate(e);console.log(`Got ICE candidate with address ${t.address}:${t.port}`)}this.signallingState.whenDoneSettingRemote(()=>{this.addIceCandidate(e)})}}async handleSDP(e){await this.setRemoteDescription(e),e.type==="offer"&&await this.askSendSignal("answer")}dispatchUrbitState(e){switch(this.urbit.verbose&&console.log("Switchboard state",e),e){case"connected-our-turn":case"connected-their-turn":this.signallingReady&&this.signallingReady();break;case"connected-our-turn-asked":this.sendSignal().catch(a=>this.closeWithError(a));break}this.urbitState=e;const t=new Ie(this.uuid||"",e);this.dispatchEvent(t),this.onurbitstatechanged(t)}async renegotiate(){await this.askSendSignal("offer")}setConfiguration(e){const t=super.getConfiguration().iceServers;super.setConfiguration(e),e.iceServers!==t&&this.restartIce()}async iceCandidatesGathered(){const e=new AbortController;return new Promise(a=>{this.addEventListener("icegatheringstatechange",()=>{this.iceGatheringState=="complete"&&a()},{signal:e.signal}),this.iceGatheringState=="complete"&&a()}).then(()=>e.abort())}},_e=class extends Event{constructor(e,t,a,i,r){super("incomingcall");u(this,"type","incomingcall"),u(this,"peer"),u(this,"dap"),u(this,"uuid"),u(this,"urbit"),u(this,"configuration"),this.peer=e,this.dap=t,this.uuid=a,this.urbit=i,this.configuration=r}get call(){return{peer:this.peer,dap:this.dap,uuid:this.uuid}}answer(){return new P(this.peer,this.dap,this.uuid,this.urbit,this.configuration)}async reject(){return this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{tag:"reject",uuid:this.uuid}})}},X=class extends Event{constructor(e){super("hungupcall");u(this,"type","hungupcall"),u(this,"uuid"),this.uuid=e}},Ie=class extends Event{constructor(e,t){super("statechanged");u(this,"type","statechanged"),u(this,"uuid"),u(this,"urbitState"),this.uuid=e,this.urbitState=t}},Te=class extends EventTarget{constructor(){super();u(this,"_state"),u(this,"_settingRemote"),u(this,"_settingRemoteDoneK"),u(this,"_whenDoneSendingK"),this._settingRemote=!1,this._settingRemoteDoneK=()=>{},this._whenDoneSendingK=()=>{},this._state="stable"}startSettingRemote(){this._settingRemote=!0}doneSettingRemote(){this._settingRemote=!1,this._settingRemoteDoneK(),this._settingRemoteDoneK=()=>{}}whenDoneSettingRemote(e){if(this._settingRemote){const t=this._settingRemoteDoneK;this._settingRemoteDoneK=()=>{t(),e()}}else e()}needToMakeOffer(){switch(this._state){case"stable":this._state="waiting-to-send-offer";break;case"sending":this._state="sending-waiting-to-send-offer";break}}gotOffer(){switch(this._state){case"stable":case"waiting-to-send-offer":this._state="waiting-to-send-answer";break;case"waiting-to-send-answer":break;case"sending":case"sending-waiting-to-send-offer":throw"Cannot receive SDP while sending"}}sending(){switch(this._state){case"waiting-to-send-offer":case"waiting-to-send-answer":this._state="sending";break;case"sending":case"sending-waiting-to-send-offer":throw"Cannot send while sending";case"stable":throw"Cannot send with nothing to send"}}doneSending(e){switch(this._state){case"sending":this._state="stable",this._whenDoneSendingK(),this._whenDoneSendingK=()=>{};break;case"sending-waiting-to-send-offer":this._state="waiting-to-send-offer",this._whenDoneSendingK(),this._whenDoneSendingK=()=>{},e();break;default:throw"Cannot be done sending if not sending"}}whenDoneSending(e){switch(this._state){case"stable":e();break;default:const t=this._whenDoneSendingK;this._whenDoneSendingK=()=>{t(),e()}}}waitingType(){switch(this._state){case"waiting-to-send-offer":return"offer";case"waiting-to-send-answer":return"answer";default:throw"Asked for waiting type but not waiting to send anything"}}},Oe=Object.defineProperty,Pe=(e,t,a)=>t in e?Oe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,v=(e,t,a)=>(Pe(e,typeof t!="symbol"?t+"":t,a),a),Me=class extends EventTarget{constructor(e=window.urbit){super();v(this,"urbit"),v(this,"iceServers"),v(this,"state"),v(this,"uid"),v(this,"oniceserver"),v(this,"onstatechange"),this.urbit=e,this.iceServers=[],this.state="uninitialized",this.oniceserver=()=>{},this.onstatechange=()=>{},this.uid="";for(let t=0;t<32;t++)this.uid+=Math.floor(Math.random()*16).toString(16)}async initialize(){await this.urbit.subscribe({app:"icepond",path:`/ice-servers/${this.uid}`,err:t=>this.handleError(t),event:t=>this.iceServer(t),quit:()=>this.done()}),this.iceServers=[],this.state="acquiring";const e=new $(this.state);this.dispatchEvent(e),this.onstatechange(e)}handleError(e){console.log("icepond error: ",e),this.state="error";const t=new $(this.state);this.dispatchEvent(t),this.onstatechange(t)}iceServer(e){this.iceServers.includes(e)==!1&&this.iceServers.push(e);const t=new je(e,this.iceServers);this.dispatchEvent(t),this.oniceserver(t)}done(){this.state="done";const e=new $(this.state);this.dispatchEvent(e),this.onstatechange(e)}},$=class extends Event{constructor(e){super("statechange");v(this,"state"),this.state=e}},je=class extends Event{constructor(e,t){super("iceserver");v(this,"newIceServer"),v(this,"iceServers"),this.newIceServer=e,this.iceServers=t}},Ae=Me;const z=!1,U="urchatfm",L=W((e,t)=>{const a={iceServers:[]},i=new Re(U,a);i.addEventListener("incomingcall",s=>{t().incomingCall===null?e({incomingCall:s}):s.reject()}),console.log("useMock:"+z);const r=new de("","");return r.ship=window.ship,i.urbit=r,{urbit:r,icepond:null,configuration:{iceServers:[]},urbitRtcApp:i,incomingCall:null,ongoingCall:null,isCaller:!1,setUrbit:s=>{const o=s;t().urbitRtcApp.urbit=o,e({urbit:o})},startIcepond:()=>e(s=>{console.log("YOU HAVE AUTHED WITH: "+s.urbit.ship),console.log("attempting icepond");const o=new Ae(s.urbit);o.oniceserver=h=>{e(l=>{const c=E(w({},l.configuration),{iceServers:h.iceServers});return console.log("icepond config:"),console.log(c),l.urbitRtcApp!==null&&(l.urbitRtcApp.configuration=c),l.incomingCall!==null&&(l.incomingCall.configuration=c),l.ongoingCall!==null&&l.ongoingCall.conn.setConfiguration(c),E(w({},l),{configuration:c})},!0)},o.initialize(),e({icepond:o})}),placeCall:async(s,o)=>{const{urbitRtcApp:h,hungup:l,startIcepond:c}=t();console.log("placeCall");const d=h.call(s,U);o(d),d.addEventListener("hungupcall",l),await d.initialize();const m={peer:s,dap:U,uuid:d.uuid};c();const f={conn:d,call:m};return e({isCaller:!0,ongoingCall:f}),f},answerCall:async s=>{const{incomingCall:o,hungup:h,startIcepond:l}=t(),c=o.call,d=o.answer();d.addEventListener("hungupcall",h),s(c.peer,d),await d.initialize(),l();const m={conn:d,call:c};return e({isCaller:!1,ongoingCall:m,incomingCall:null}),m},reconnectCall:async(s,o)=>{const h=t().urbit,l=await P.reconnect({urbit:h,uuid:s}),c={uuid:s,peer:l.peer,dap:l.dap},d={call:c,conn:l},{hungup:m,startIcepond:f}=t();return l.addEventListener("hungupcall",m),o(c.peer,l),await l.initialize(),f(),e({ongoingCall:d}),d},rejectCall:()=>e(s=>(s.incomingCall.reject(),{incomingCall:null})),hangup:()=>e(s=>(s.ongoingCall&&s.ongoingCall.conn.close(),E(w({},s),{ongoingCall:null}))),hungup:()=>e({ongoingCall:null})}});var $e="/apps/urchatfm/assets/ring.b27464db.wav";const ze=({caller:e,answerCall:t,rejectCall:a})=>(p.exports.useEffect(()=>{new Audio($e).play()},[]),n.createElement("div",{className:"fixed top-4 right-4 inline-block px-8 py-4 space-y-4 bg-gray-100 rounded-xl shadow-lg"},n.createElement("h2",null,"Call from ~",n.createElement("span",{className:"font-mono font-semibold"},e)),n.createElement("div",{className:"flex space-x-3"},n.createElement("button",{className:"flex-1 button text-green-900 bg-green-500",onClick:t},"Answer"),n.createElement("button",{className:"flex-1 button text-red-900 bg-red-500",onClick:a},"Reject")))),Ue=({sendMessage:e,messages:t,ready:a})=>{const{register:i,handleSubmit:r,reset:s}=B({defaultValues:{message:""}}),o=!a&&!z,h=p.exports.useCallback(({message:l})=>{console.log(l),e(l),s()},[e]);return n.createElement("div",{className:`flex flex-col h-full p-3 sm:p-6 text-sm bg-pink-100 lg:rounded-xl overflow-hidden ${o?"opacity-50":""}`},n.createElement("div",{className:"flex-1 h-full px-4 py-3 bg-white rounded-md overflow-y-auto"},n.createElement("div",{className:"flex flex-col-reverse justify-start"},t.map((l,c)=>n.createElement("div",{className:"mt-4",key:c},n.createElement("span",{className:"font-bold mr-3"},l.speaker,":"),l.message)))),n.createElement("form",{className:"flex-none flex mt-3 sm:mt-6 relative rounded-md focus-within:ring-2 ring-pink-300 focus-within:outline-none",onSubmit:r(h)},n.createElement("label",{htmlFor:"message",className:"sr-only"},"Send a Message:"),n.createElement("input",E(w({id:"message",type:"text",className:"flex-1 input rounded-r-none focus:outline-none"},i("message")),{disabled:o})),n.createElement("button",{type:"submit",disabled:o,className:"flex-none button px-6 text-pink-900 bg-pink-500 rounded-l-none"},"Send")))},N=W((e,t)=>({local:new MediaStream,remote:new MediaStream,video:{enabled:!0,device:null,tracks:[],changeDevice:(a,i)=>M(a,"video",t(),i),toggle:()=>{e({video:Z(t().video)})}},audio:{enabled:!0,device:null,tracks:[],changeDevice:(a,i)=>M(a,"audio",t(),i),toggle:()=>{e({audio:Z(t().audio)})}},devices:[],resetStreams:()=>{e({local:new MediaStream,remote:new MediaStream})},getDevices:async a=>{var l;const i=await((l=navigator.mediaDevices)==null?void 0:l.enumerateDevices()),r=i.filter(c=>c.kind==="videoinput"),s=i.filter(c=>c.kind==="audioinput"),o=await M(r[0],"video",t(),a),h=await M(s[0],"audio",t(),a);e({devices:i,video:o,audio:h})}}));function Z(e){return e.enabled=!e.enabled,e.tracks.forEach(t=>{t.enabled=e.enabled}),e}const Le={video:{facingMode:"user",width:1280,height:719},audio:null};async function M(e,t,a,i){var c;const r=a[t],s=d=>{var f;console.log("Adding track to call",d),a.local.addTrack(d);const m=(f=i.conn)==null?void 0:f.addTrack(d);return d.sender=m,d},o=d=>{var m;console.log("Removing track from call",d),a.local.removeTrack(d);try{(m=i.conn)==null||m.removeTrack(d.sender)}catch(f){console.log(f)}d.stop()},h={[t]:w({deviceId:e.deviceId},Le[t])},l=await((c=navigator.mediaDevices)==null?void 0:c.getUserMedia(h));return r.tracks.forEach(o),r.tracks=t==="audio"?l.getAudioTracks().map(s):l.getVideoTracks().map(s),r.device=e,r}const He=({className:e="",primary:t=""})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,fillRule:"evenodd",d:"M15.78 14.36a1 1 0 0 1-1.42 1.42l-2.82-2.83-2.83 2.83a1 1 0 1 1-1.42-1.42l2.83-2.82L7.3 8.7a1 1 0 0 1 1.42-1.42l2.83 2.83 2.82-2.83a1 1 0 0 1 1.42 1.42l-2.83 2.83 2.83 2.82z"})),ee=a=>{var i=a,{children:e}=i,t=T(i,["children"]);return n.createElement(me,w({},t),n.createElement(pe,{className:"fixed z-10 top-0 left-0 right-0 bottom-0 dark:bg-white bg-black opacity-30"}),e)},te=n.forwardRef((s,r)=>{var o=s,{children:e,showCloseIcon:t=!0,className:a="p-6"}=o,i=T(o,["children","showCloseIcon","className"]);return n.createElement(he,E(w({className:"fixed z-40 top-1/2 left-1/2 bg-gray-100 rounded-xl default-ring transform -translate-y-1/2 -translate-x-1/2"},i),{ref:r}),n.createElement("div",{className:`relative ${a}`},e,t&&n.createElement(ge,{className:"absolute top-2 right-2 text-gray-300 dark:text-gray-700 hover:text-gray-400 dark:hover:text-gray-500 focus:text-gray-400 dark:focus:text-gray-500 default-ring rounded"},n.createElement(He,{className:"w-7 h-7",primary:"fill-current"}))))}),Ke=fe,Ve=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:a,d:"M13.59 12l6.7-6.7A1 1 0 0 1 22 6v12a1 1 0 0 1-1.7.7L13.58 12z"}),n.createElement("rect",{width:"14",height:"14",x:"2",y:"5",className:t,rx:"2"})),Fe=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,d:"M11 4h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V6h-2v12h2v-2a1 1 0 0 1 2 0v3a1 1 0 0 1-1 1h-3v1a1 1 0 0 1-1.27.96l-6.98-2A1 1 0 0 1 2 19V5a1 1 0 0 1 .75-.97l6.98-2A1 1 0 0 1 11 3v1z"}),n.createElement("path",{className:a,d:"M18.59 11l-1.3-1.3c-.94-.94.47-2.35 1.42-1.4l3 3a1 1 0 0 1 0 1.4l-3 3c-.95.95-2.36-.46-1.42-1.4l1.3-1.3H14a1 1 0 0 1 0-2h4.59z"})),We=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:a,d:"M12 1a4 4 0 0 1 4 4v6a4 4 0 1 1-8 0V5a4 4 0 0 1 4-4z"}),n.createElement("path",{className:t,d:"M13 18.94V21h3a1 1 0 0 1 0 2H8a1 1 0 0 1 0-2h3v-2.06A8 8 0 0 1 4 11a1 1 0 0 1 2 0 6 6 0 1 0 12 0 1 1 0 0 1 2 0 8 8 0 0 1-7 7.94z"})),Be=({className:e="",primary:t="",secondary:a=""})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,d:"M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2zm11 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm-8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"}),n.createElement("path",{className:a,d:"M9.73 14H17a1 1 0 0 1 0 2H9.73a2 2 0 0 0 0-2zm4.54-6a2 2 0 0 0 0 2H7a1 1 0 1 1 0-2h7.27z"})),ne=n.forwardRef(({defaultPressed:e,pressed:t,onPressedChange:a,disabled:i,children:r,className:s},o)=>{const[h,l]=p.exports.useState(e),c=!!a,d=c?t:h,m=c?a:l;return n.createElement(be,{className:k("flex items-center justify-center default-ring rounded-full",i&&d&&"text-gray-400 bg-gray-700",d&&"text-gray-200 bg-gray-700",!d&&"text-pink-900 bg-pink-500",s),pressed:d,onPressedChange:m,disabled:i,ref:o},r)});function qe(){const{ongoingCall:e}=L(),{audio:t,video:a,devices:i}=N(),r=i.filter(l=>l.kind==="videoinput"),s=i.filter(l=>l.kind==="audioinput"),o=l=>{const c=r[parseInt(l.target.value)];a.changeDevice(c,e)},h=l=>{const c=s[parseInt(l.target.value)];t.changeDevice(c,e)};return n.createElement("div",{className:"space-y-6"},n.createElement("div",{className:"VideoInputs"},n.createElement("h2",{className:"font-semibold"},"Camera"),n.createElement("select",{className:"input default-ring bg-gray-200",onChange:o},r.map((l,c)=>n.createElement("option",{key:c,value:c},l.label===""?l.groupId:l.label)))),n.createElement("div",{className:"AudioInputs"},n.createElement("h2",{className:"font-semibold"},"Microphone"),n.createElement("select",{className:"input default-ring bg-gray-200",onChange:h},s.map((l,c)=>n.createElement("option",{key:c,value:c},l.label===""?l.groupId:l.label)))))}const Ge=({className:e})=>{const{push:t}=q(),{audio:a,video:i}=N(o=>({audio:o.audio,video:o.video})),r=L(o=>o.hangup),s=p.exports.useCallback(()=>{r(),a.tracks.forEach(o=>o.stop()),i.tracks.forEach(o=>o.stop()),t("/")},[]);return n.createElement("div",{className:k("flex justify-center p-3 space-x-3",e)},n.createElement(ne,{className:"w-10 h-10",pressed:i.enabled,onPressedChange:i.toggle},n.createElement(Ve,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Video")),n.createElement(ne,{className:"w-10 h-10",pressed:a.enabled,onPressedChange:a.toggle},n.createElement(We,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Audio")),n.createElement(ee,null,n.createElement(Ke,{className:"flex justify-center items-center w-10 h-10 text-gray-200 bg-gray-700 rounded-full default-ring"},n.createElement(Be,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Devices")),n.createElement(te,{className:"w-full max-w-xl py-8 px-12"},n.createElement(qe,null))),n.createElement("button",{className:"flex justify-center items-center w-10 h-10 text-pink-900 bg-pink-500 rounded-full default-ring",onClick:s},n.createElement(Fe,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Hang up")))},Ye=({className:e})=>n.createElement("span",{className:`flex-none inline-block relative ${e}`},n.createElement("span",{className:"block absolute w-full h-full border-2 border-transparent border-t-pink-400 rounded-full animate-spin"}),n.createElement("span",{className:"block relative w-full h-full border border-pink-700 rounded-full"}));function Je(e){const t=e.srcObject,a=p.exports.useRef(null),i=E(w({},e),{autoPlay:!0,ref:a});return delete i.srcObject,p.exports.useEffect(()=>{!a.current||(a.current.srcObject=t)},[a,t]),n.createElement("video",i,null)}const ae=i=>{var r=i,{size:e,className:t}=r,a=T(r,["size","className"]);return n.createElement("div",{className:k("relative bg-gray-500 overflow-hidden",e==="xs-mini"&&"w-20 sm:w-28 shadow-md rounded-xl",e==="mini"&&"w-32 sm:w-64",e==="large"&&"w-full lg:rounded-xl",t)},n.createElement(Je,E(w({},a),{className:k("absolute w-full h-full object-cover md:object-contain transform"),style:{transform:"rotateY(180deg)"}})))},Qe=({connected:e})=>{var s,o;const{local:t,remote:a,video:i}=N(h=>({local:h.local,remote:h.remote,video:h.video})),r=((o=(s=i.tracks[0])==null?void 0:s.getSettings())==null?void 0:o.aspectRatio)>1||!0;return n.createElement(n.Fragment,null,n.createElement("div",{className:"relative w-full h-full"},n.createElement("div",{className:"absolute z-10 top-2 left-2 sm:top-6 sm:left-6"},n.createElement(ae,{size:r?"mini":"xs-mini",muted:!0,srcObject:t,className:k("border border-white",r&&"aspect-w-16 aspect-h-9",!r&&"aspect-w-9 aspect-h-16")})),n.createElement(ae,{size:"large",className:"absolute inset-0 h-full w-full",srcObject:a,muted:z}),!e&&n.createElement("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"},n.createElement("div",{className:"flex items-center mb-2"},n.createElement(Ye,{className:"h-6 w-6 mr-2"}),n.createElement("h2",{className:"font-semibold text-xl text-pink-400"},"Connecting...")),n.createElement("p",{className:"text-gray-300"},"This could take up to a minute.")),n.createElement(Ge,{className:"absolute z-10 bottom-0 left-1/2 transform -translate-x-1/2"})))},Xe=({placeCall:e})=>{const{register:t,handleSubmit:a,reset:i,watch:r}=B({mode:"onChange",defaultValues:{ship:""}}),s=r("ship"),o=p.exports.useCallback(({ship:h})=>{!h||(e(G(h)),i())},[]);return n.createElement("form",{onSubmit:a(o),className:"p-12 bg-gray-200 rounded-xl shadow-xl"},n.createElement("label",{htmlFor:"ship",className:"sr-only"},"Ship"),n.createElement("div",{className:"flex rounded-md focus-within:ring-2 ring-pink-300 focus-within:outline-none"},n.createElement("input",w({id:"ship",type:"text",placeholder:"Ship",className:"flex-1 input min-w-[200px] font-semibold font-mono rounded-r-none focus:outline-none"},t("ship"))),n.createElement("button",{type:"submit",className:"flex-none button px-6 text-pink-900 bg-pink-500 disabled:text-gray-900 disabled:bg-gray-400 disabled:cursor-default rounded-l-none",disabled:!we.isValidPatp(`~${G(s)}`||"")&&s.length>0},"Call")))};var Ze="/apps/urchatfm/assets/enter-call.c4287b6d.wav";const et=()=>{const e=p.exports.useCallback(()=>{},[]);return n.createElement(ve,{defaultOpen:!0,onOpenChange:e},n.createElement(Ee,{className:"fixed bottom-4 right-4 inline-block max-w-sm px-8 py-4 space-y-4 bg-gray-100 rounded-xl shadow-lg"},n.createElement("h2",null,"You won't hear incoming calls until you hit this button or interact with the page"),n.createElement(ye,{className:"flex-1 button text-pink-900 bg-pink-500 default-ring"},"Turn On Ringer")))},tt=()=>{const e=p.exports.useCallback(t=>t.preventDefault(),[]);return n.createElement(ee,{defaultOpen:!0},n.createElement(te,{onPointerDownOutside:e,onFocusOutside:e,onInteractOutside:e,showCloseIcon:!1,className:"max-w-lg p-8 text-gray-700"},n.createElement("p",null,"urChatFM is built on top of WebRTC which requires HTTPS to function. You may need to provision a certificate for your Urbit, or you just need to visit the HTTPS version of your site."),n.createElement("div",{className:"flex items-center mt-4 space-x-4"},n.createElement("a",{className:"button text-pink-900 bg-pink-500 default-ring",href:`https://${location.hostname}${location.port&&":"+location.port}${location.pathname}`},"Try HTTPS version of this page"),n.createElement("a",{className:"button text-pink-900 bg-pink-500 default-ring",href:"https://urbit.org/using/os/basics#configuring-ssl"},"Configure SSL certificate"))))};function nt(){const{incomingCall:e,ongoingCall:t,answerCall:a,placeCall:i,rejectCall:r,hangup:s}=L(),{resetStreams:o,getDevices:h}=N(g=>({getDevices:g.getDevices,resetStreams:g.resetStreams})),{push:l}=q(),[c,d]=p.exports.useState(null),[m,f]=p.exports.useState(!1),[D,y]=p.exports.useState([]),j=location.protocol.startsWith("https")||location.hostname==="localhost";p.exports.useEffect(()=>(window.addEventListener("beforeunload",s),()=>window.removeEventListener("beforeunload",s)),[]),p.exports.useEffect(()=>{if(j&&t){const g=new Audio(Ze);g.volume=.3,g.play(),l(`/chat/${t.conn.uuid}`);const b=()=>h(t);return navigator.mediaDevices.addEventListener("devicechange",b),()=>navigator.mediaDevices.removeEventListener("devicechange",b)}},[t]);const H=p.exports.useCallback(g=>{console.log("Incoming track event",g);const{remote:b}=N.getState();b.addTrack(g.track)},[]),se=async()=>{o();const g=await a((b,S)=>{f(!1),y([]),S.addEventListener("datachannel",x=>{const C=x.channel;C.onopen=()=>f(!0),C.onmessage=R=>{const _=R.data;y(oe=>[{speaker:b,message:_}].concat(oe)),console.log("channel message",_)},d(C)}),S.ontrack=H});h(g)},ie=async g=>{o();const b=await i(g,S=>{console.log("placing call"),f(!1),y([]);const x=S.createDataChannel("urchatfm");x.onopen=()=>f(!0),x.onmessage=C=>{const R=C.data;y(_=>[{speaker:"~"+g,message:R}].concat(_)),console.log("channel message from ~"+g+": "+R)},d(x),S.ontrack=H});h(b)},re=p.exports.useCallback(g=>{c==null||c.send(g);const b=[{speaker:"me",message:g}].concat(D);console.log(D,b),y(b)},[D,c]);return n.createElement("main",{className:"relative flex flex-col lg:flex-row lg:gap-6 w-full h-full lg:p-8 text-gray-700"},n.createElement("section",{className:"flex-auto lg:flex-1 flex flex-col justify-center h-[50%] lg:h-auto"},n.createElement(Y,null,n.createElement(O,{path:"/chat/:id"},n.createElement(Qe,{connected:m})),n.createElement(O,{path:"/"},n.createElement("div",{className:"flex justify-center items-center w-full h-full bg-pink-100 rounded-xl"},n.createElement("div",null,n.createElement("h1",{className:"mb-6 mx-12 text-3xl font-semibold font-mono"},"urChatFM"),n.createElement(Xe,{placeCall:ie})))))),n.createElement("aside",{className:"flex-auto lg:flex-none lg:w-[33vw] lg:max-w-sm h-[50%] lg:h-auto"},n.createElement(Y,null,n.createElement(O,{path:"/chat/:id"},n.createElement(Ue,{sendMessage:re,messages:D,ready:m})),n.createElement(O,{path:"/"},n.createElement("div",{className:"h-full bg-gray-300 lg:rounded-xl"})))),e&&n.createElement(ze,{caller:e.call.peer,answerCall:se,rejectCall:r}),j&&n.createElement(et,null),!j&&n.createElement(tt,null))}function at(){return n.createElement(Se,{basename:"/apps/urchatfm"},n.createElement(nt,null))}xe.render(n.createElement(n.StrictMode,null,n.createElement(at,null)),document.getElementById("root"));
