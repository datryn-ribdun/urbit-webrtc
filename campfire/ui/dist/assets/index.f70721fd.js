var le=Object.defineProperty,ce=Object.defineProperties;var de=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var q=(e,t,a)=>t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,w=(e,t)=>{for(var a in t||(t={}))W.call(t,a)&&q(e,a,t[a]);if(T)for(var a of T(t))B.call(t,a)&&q(e,a,t[a]);return e},S=(e,t)=>ce(e,de(t));var I=(e,t)=>{var a={};for(var i in e)W.call(e,i)&&t.indexOf(i)<0&&(a[i]=e[i]);if(e!=null&&T)for(var i of T(e))t.indexOf(i)<0&&B.call(e,i)&&(a[i]=e[i]);return a};import{c as G,U as ue,r as p,R as n,s as he,a as ge,u as Y,C as me,b as pe,d as fe,O as be,T as we,e as ve,f as x,g as J,h as A,i as Ee,D as Se,j as xe,k as ye,S as Q,l as P,B as Ce,m as ke}from"./vendor.2c4a3ca5.js";const Ne=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function a(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=a(r);fetch(r.href,s)}};Ne();var De=Object.defineProperty,X=Object.getOwnPropertySymbols,_e=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable,H=(e,t,a)=>t in e?De(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,Z=(e,t)=>{for(var a in t||(t={}))_e.call(t,a)&&H(e,a,t[a]);if(X)for(var a of X(t))Re.call(t,a)&&H(e,a,t[a]);return e},u=(e,t,a)=>(H(e,typeof t!="symbol"?t+"":t,a),a),Te=class extends EventTarget{constructor(e,t,a=window.urbit){super();u(this,"_urbit"),u(this,"configuration"),u(this,"dap"),u(this,"subscriptionId"),u(this,"onincomingcall"),u(this,"onhungupcall"),u(this,"onerror"),this._urbit=a,this.configuration=t,this.dap=e,this.onincomingcall=()=>{},this.onhungupcall=()=>{},this.onerror=()=>{},this.subscriptionId=null}initialize(){return this.subscriptionId=this._urbit.subscribe({app:"switchboard",path:`/incoming/${this.dap}`,err:e=>this.onerror(e),event:e=>this.handleIncoming(e),quit:()=>this.initialize()}),this.subscriptionId}handleIncoming(e){e.type=="incoming"?this.incomingCall(e):e.type=="hangup"&&this.hungupCall(e.uuid)}set urbit(e){this._urbit=e,this.initialize()}incomingCall(e){const t=new Ie(e.peer,this.dap,e.uuid,this._urbit,this.configuration);this.onincomingcall(t),this.dispatchEvent(t)}hungupCall(e){const t=new ee(e);this.onhungupcall(t),this.dispatchEvent(t)}call(e,t){return new O(e,t,void 0,this._urbit,this.configuration)}},O=class extends RTCPeerConnection{constructor(e,t,a,i,r){super(r);u(this,"urbit"),u(this,"reconnect"),u(this,"peer"),u(this,"dap"),u(this,"uuid"),u(this,"subscriptionId"),u(this,"urbitState"),u(this,"signallingReady"),u(this,"signallingReadyPromise"),u(this,"signallingState"),u(this,"onerror"),u(this,"onurbitstatechanged"),this.urbit=i,this.reconnect=!1,this.peer=e,this.dap=t,this.uuid=a,this.subscriptionId=null,this.onerror=()=>{},this.onurbitstatechanged=()=>{},this.signallingReady=null,this.signallingReadyPromise=new Promise(s=>this.signallingReady=()=>{this.signallingReady=()=>{},s()}),this.onicecandidate=s=>this.signallingState.whenDoneSending(()=>{s.candidate!==null&&this.canTrickleIceCandidates&&this.signallingReadyPromise.then(()=>{var o;this.urbit.verbose&&console.log("Sending ICE candidate for address ${evt.candidate.address}:${evt.candidate.port}"),this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:Z({uuid:this.uuid,tag:"icecandidate"},(o=s.candidate)==null?void 0:o.toJSON())})}).catch(o=>this.closeWithError(o))}),this.onnegotiationneeded=()=>this.renegotiate(),this.urbitState=null,this.signallingState=new Oe}async initialize(){this.reconnect?await this.resubscribe():typeof this.uuid=="undefined"?(this.dispatchUrbitState("dialing"),await this.dial()):(this.dispatchUrbitState("incoming-ringing"),await this.subscribe())}static async reconnect(e){var t=e.uuid,a=e.urbit?e.urbit:window.urbit,i=await a.scry({app:"switchboard",path:`/call/${t}/peer`}),r=await a.scry({app:"switchboard",path:`/call/${t}/dap`}),s=new O(i,r,t,a);return s.reconnect=!0,s}async dial(){await this.urbit.subscribe({app:"switchboard",path:"/uuid",err:e=>this.closeWithError(e),event:e=>this.ring(e),quit:()=>{}})}async ring(e){return this.uuid=e,this.urbit.verbose&&console.log("Call UUID:",this.uuid),await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{uuid:this.uuid,tag:"place-call",peer:this.peer,dap:this.dap}}).catch(t=>this.closeWithError(t)),this.subscribe()}subscribe(){return this.subscriptionId=this.urbit.subscribe({app:"switchboard",path:`/call/${this.uuid}`,err:e=>this.closeWithError(e),event:e=>this.handleFact(e),quit:()=>this.resubscribe()}),this.subscriptionId}async resubscribe(){if(this.connectionState!=="closed"){await this.subscribe();const e=await this.urbit.scry({app:"switchboard",path:`/call/${this.uuid}/last-remote`});e!==null&&(this.signallingState.startSettingRemote(),await this.setRemoteDescription(e.msg),this.signallingState.doneSettingRemote()),this.restartIce()}else throw"Will not resubscribe for closed connection"}close(){var e=new Promise(a=>{super.close(),a()}),t=this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{tag:"reject",uuid:this.uuid}});Promise.all([e,t]).then(()=>{this.subscriptionId!==null&&this.subscriptionId.then(a=>this.urbit.unsubscribe(a))})}remoteHungup(){this.connectionState!="closed"&&(super.close(),super.dispatchEvent(new ee(this.uuid||"")))}closeWithError(e){this.close(),console.log("Closed with error",e),this.onerror(e)}async sendSignal(){var e;const t=this.signallingState.waitingType();if(this.urbit.verbose&&console.log("Sending SDP ${signalType}"),this.signallingState.sending(),t==="offer"){const a=await this.createOffer();await this.setLocalDescription(a),this.canTrickleIceCandidates||await this.iceCandidatesGathered()}else{const a=await this.createAnswer();await this.setLocalDescription(a),this.canTrickleIceCandidates||await this.iceCandidatesGathered()}await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:Z({uuid:this.uuid,tag:"sdp"},(e=this.localDescription)==null?void 0:e.toJSON())}),await this.signallingState.doneSending(this.askSignal.bind(this))}async askSignal(){await this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{uuid:this.uuid,tag:"ask-signal"}})}async askSendSignal(e){switch(await this.signallingReadyPromise,e){case"offer":this.signallingState.needToMakeOffer();break;case"answer":this.signallingState.gotOffer();break;default:throw"signalType must be offer or answer"}await this.askSignal()}handleFact(e){switch(e.tag){case"connection-state":this.signallingState.whenDoneSettingRemote(()=>this.dispatchUrbitState(e.connectionState));return;case"hungup":this.remoteHungup();return;case"sdp":this.urbit.verbose&&console.log("Got SDP ${fact.type}"),this.signallingState.startSettingRemote(),this.handleSDP(e).then(()=>this.signallingState.doneSettingRemote());return;case"icecandidate":if(this.urbit.verbose){const t=new RTCIceCandidate(e);console.log(`Got ICE candidate with address ${t.address}:${t.port}`)}this.signallingState.whenDoneSettingRemote(()=>{this.addIceCandidate(e)})}}async handleSDP(e){await this.setRemoteDescription(e),e.type==="offer"&&await this.askSendSignal("answer")}dispatchUrbitState(e){switch(this.urbit.verbose&&console.log("Switchboard state",e),e){case"connected-our-turn":case"connected-their-turn":this.signallingReady&&this.signallingReady();break;case"connected-our-turn-asked":this.sendSignal().catch(a=>this.closeWithError(a));break}this.urbitState=e;const t=new Pe(this.uuid||"",e);this.dispatchEvent(t),this.onurbitstatechanged(t)}async renegotiate(){await this.askSendSignal("offer")}setConfiguration(e){const t=super.getConfiguration().iceServers;super.setConfiguration(e),e.iceServers!==t&&this.restartIce()}async iceCandidatesGathered(){const e=new AbortController;return new Promise(a=>{this.addEventListener("icegatheringstatechange",()=>{this.iceGatheringState=="complete"&&a()},{signal:e.signal}),this.iceGatheringState=="complete"&&a()}).then(()=>e.abort())}},Ie=class extends Event{constructor(e,t,a,i,r){super("incomingcall");u(this,"type","incomingcall"),u(this,"peer"),u(this,"dap"),u(this,"uuid"),u(this,"urbit"),u(this,"configuration"),this.peer=e,this.dap=t,this.uuid=a,this.urbit=i,this.configuration=r}get call(){return{peer:this.peer,dap:this.dap,uuid:this.uuid}}answer(){return new O(this.peer,this.dap,this.uuid,this.urbit,this.configuration)}async reject(){return this.urbit.poke({app:"switchboard",mark:"switchboard-from-client",json:{tag:"reject",uuid:this.uuid}})}},ee=class extends Event{constructor(e){super("hungupcall");u(this,"type","hungupcall"),u(this,"uuid"),this.uuid=e}},Pe=class extends Event{constructor(e,t){super("statechanged");u(this,"type","statechanged"),u(this,"uuid"),u(this,"urbitState"),this.uuid=e,this.urbitState=t}},Oe=class extends EventTarget{constructor(){super();u(this,"_state"),u(this,"_settingRemote"),u(this,"_settingRemoteDoneK"),u(this,"_whenDoneSendingK"),this._settingRemote=!1,this._settingRemoteDoneK=()=>{},this._whenDoneSendingK=()=>{},this._state="stable"}startSettingRemote(){this._settingRemote=!0}doneSettingRemote(){this._settingRemote=!1,this._settingRemoteDoneK(),this._settingRemoteDoneK=()=>{}}whenDoneSettingRemote(e){if(this._settingRemote){const t=this._settingRemoteDoneK;this._settingRemoteDoneK=()=>{t(),e()}}else e()}needToMakeOffer(){switch(this._state){case"stable":this._state="waiting-to-send-offer";break;case"sending":this._state="sending-waiting-to-send-offer";break}}gotOffer(){switch(this._state){case"stable":case"waiting-to-send-offer":this._state="waiting-to-send-answer";break;case"waiting-to-send-answer":break;case"sending":case"sending-waiting-to-send-offer":throw"Cannot receive SDP while sending"}}sending(){switch(this._state){case"waiting-to-send-offer":case"waiting-to-send-answer":this._state="sending";break;case"sending":case"sending-waiting-to-send-offer":throw"Cannot send while sending";case"stable":throw"Cannot send with nothing to send"}}doneSending(e){switch(this._state){case"sending":this._state="stable",this._whenDoneSendingK(),this._whenDoneSendingK=()=>{};break;case"sending-waiting-to-send-offer":this._state="waiting-to-send-offer",this._whenDoneSendingK(),this._whenDoneSendingK=()=>{},e();break;default:throw"Cannot be done sending if not sending"}}whenDoneSending(e){switch(this._state){case"stable":e();break;default:const t=this._whenDoneSendingK;this._whenDoneSendingK=()=>{t(),e()}}}waitingType(){switch(this._state){case"waiting-to-send-offer":return"offer";case"waiting-to-send-answer":return"answer";default:throw"Asked for waiting type but not waiting to send anything"}}},Me=Object.defineProperty,je=(e,t,a)=>t in e?Me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,E=(e,t,a)=>(je(e,typeof t!="symbol"?t+"":t,a),a),ze=class extends EventTarget{constructor(e=window.urbit){super();E(this,"urbit"),E(this,"iceServers"),E(this,"state"),E(this,"uid"),E(this,"oniceserver"),E(this,"onstatechange"),this.urbit=e,this.iceServers=[],this.state="uninitialized",this.oniceserver=()=>{},this.onstatechange=()=>{},this.uid="";for(let t=0;t<32;t++)this.uid+=Math.floor(Math.random()*16).toString(16)}async initialize(){await this.urbit.subscribe({app:"icepond",path:`/ice-servers/${this.uid}`,err:t=>this.handleError(t),event:t=>this.iceServer(t),quit:()=>this.done()}),this.iceServers=[],this.state="acquiring";const e=new L(this.state);this.dispatchEvent(e),this.onstatechange(e)}handleError(e){console.log("icepond error: ",e),this.state="error";const t=new L(this.state);this.dispatchEvent(t),this.onstatechange(t)}iceServer(e){this.iceServers.includes(e)==!1&&this.iceServers.push(e);const t=new $e(e,this.iceServers);this.dispatchEvent(t),this.oniceserver(t)}done(){this.state="done";const e=new L(this.state);this.dispatchEvent(e),this.onstatechange(e)}},L=class extends Event{constructor(e){super("statechange");E(this,"state"),this.state=e}},$e=class extends Event{constructor(e,t){super("iceserver");E(this,"newIceServer"),E(this,"iceServers"),this.newIceServer=e,this.iceServers=t}},Ae=ze,He=Object.defineProperty,Le=(e,t,a)=>t in e?He(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,Fe=(e,t,a)=>(Le(e,typeof t!="symbol"?t+"":t,a),a),Ue=class extends EventTarget{constructor(e=window.urbit){super();Fe(this,"urbit"),this.urbit=e}async getPals(){return await this.urbit.scry({app:"pals",path:"/json"})}addPal(e,t=[]){this.urbit.poke({app:"pals",mark:"pals-command",json:{meet:{ship:e,in:t}}})}removePal(e){this.urbit.poke({app:"pals",mark:"pals-command",json:{part:{ship:e,in:[]}}})}},Ve=Ue;const te=!1,F="urchatfm",M=G((e,t)=>{const a={iceServers:[]},i=new Te(F,a);i.addEventListener("incomingcall",s=>{t().incomingCall===null?e({incomingCall:s}):s.reject()}),console.log("useMock:"+te);const r=new ue("","");return r.ship=window.ship,i.urbit=r,{urbit:r,icepond:null,configuration:{iceServers:[]},urbitRtcApp:i,incomingCall:null,ongoingCall:null,isCaller:!1,setUrbit:s=>{const o=s;t().urbitRtcApp.urbit=o,e({urbit:o})},startIcepond:()=>e(s=>{console.log("attempting icepond");const o=new Ae(s.urbit);o.oniceserver=d=>{e(l=>{const c=S(w({},l.configuration),{iceServers:d.iceServers});return console.log("icepond config:"),console.log(c),l.urbitRtcApp!==null&&(l.urbitRtcApp.configuration=c),l.incomingCall!==null&&(l.incomingCall.configuration=c),l.ongoingCall!==null&&l.ongoingCall.conn.setConfiguration(c),S(w({},l),{configuration:c})},!0)},o.initialize(),e({icepond:o})}),fetchPals:()=>e(s=>{console.log("urchat store fetch pals"),new Ve(s.urbit).getPals()}),placeCall:async(s,o)=>{const{urbitRtcApp:d,hungup:l,startIcepond:c,fetchPals:g}=t();g(),console.log("placeCall");const h=d.call(s,F);o(h),h.addEventListener("hungupcall",l),await h.initialize();const f={peer:s,dap:F,uuid:h.uuid};c();const v={conn:h,call:f};return e({isCaller:!0,ongoingCall:v}),v},answerCall:async s=>{const{incomingCall:o,hungup:d,startIcepond:l}=t(),c=o.call,g=o.answer();g.addEventListener("hungupcall",d),s(c.peer,g),await g.initialize(),l();const h={conn:g,call:c};return e({isCaller:!1,ongoingCall:h,incomingCall:null}),h},reconnectCall:async(s,o)=>{const d=t().urbit,l=await O.reconnect({urbit:d,uuid:s}),c={uuid:s,peer:l.peer,dap:l.dap},g={call:c,conn:l},{hungup:h,startIcepond:f}=t();return l.addEventListener("hungupcall",h),o(c.peer,l),await l.initialize(),f(),e({ongoingCall:g}),g},rejectCall:()=>e(s=>(s.incomingCall.reject(),{incomingCall:null})),hangup:()=>e(s=>(s.ongoingCall&&s.ongoingCall.conn.close(),S(w({},s),{ongoingCall:null}))),hungup:()=>e({ongoingCall:null})}});var Ke="/apps/urchatfm/assets/ring.b27464db.wav";const We=e=>n.createElement(n.Fragment,null,he({patp:e.patp,renderer:ge,size:64,colors:["black","white"]})),Be=({caller:e,answerCall:t,rejectCall:a})=>(p.exports.useEffect(()=>{new Audio(Ke).play()},[]),n.createElement("div",{className:"fixed top-4 right-4 gap-x-3 flex inline-block px-8 py-4 bg-gray-100 rounded-xl shadow-lg"},n.createElement("div",{className:"flex-1"},n.createElement(We,{patp:e})),n.createElement("div",{className:"flex-1"},n.createElement("h2",null,"Call from ~",n.createElement("span",{className:"font-mono font-semibold"},e)),n.createElement("div",{className:"flex space-x-3"},n.createElement("button",{className:"flex-1 button text-green-900 bg-green-500",onClick:t},"Answer"),n.createElement("button",{className:"flex-1 button text-red-900 bg-red-500",onClick:a},"Reject"))))),qe=({sendMessage:e,messages:t,ready:a})=>{const{register:i,handleSubmit:r,reset:s}=Y({defaultValues:{message:""}}),o=!a&&!te,d=p.exports.useCallback(({message:l})=>{console.log(l),e(l),s()},[e]);return n.createElement("div",{className:`flex flex-col h-full p-3 sm:p-6 text-sm bg-pink-100 lg:rounded-xl overflow-hidden ${o?"opacity-50":""}`},n.createElement("div",{className:"flex-1 h-full px-4 py-3 bg-white rounded-md overflow-y-auto"},n.createElement("div",{className:"flex flex-col-reverse justify-start"},t.map((l,c)=>n.createElement("div",{className:"mt-4",key:c},n.createElement("span",{className:"font-bold mr-3"},l.speaker,":"),l.message)))),n.createElement("form",{className:"flex-none flex mt-3 sm:mt-6 relative rounded-md focus-within:ring-2 ring-pink-300 focus-within:outline-none",onSubmit:r(d)},n.createElement("label",{htmlFor:"message",className:"sr-only"},"Send a Message:"),n.createElement("input",S(w({id:"message",type:"text",className:"flex-1 input rounded-r-none focus:outline-none"},i("message")),{disabled:o})),n.createElement("button",{type:"submit",disabled:o,className:"flex-none button px-6 text-pink-900 bg-pink-500 rounded-l-none"},"Send")))},y=G((e,t)=>({local:new MediaStream,remote:new MediaStream,video:{enabled:!0,device:null,tracks:[],changeDevice:(a,i)=>j(a,"video",t(),i),toggle:()=>{e({video:ne(t().video)})}},audio:{enabled:!0,device:null,tracks:[],changeDevice:(a,i)=>j(a,"audio",t(),i),toggle:()=>{e({audio:ne(t().audio)})}},sharedScreen:{enabled:!1,tracks:[],toggle:async()=>{var a=t().sharedScreen;a.enabled?e({sharedScreen:await Je(t())}):e({sharedScreen:await Ye(t())})}},devices:[],resetStreams:()=>{e({local:new MediaStream,remote:new MediaStream})},call:null,getDevices:async a=>{var l;const i=await((l=navigator.mediaDevices)==null?void 0:l.enumerateDevices()),r=i.filter(c=>c.kind==="videoinput"),s=i.filter(c=>c.kind==="audioinput"),o=await j(r[0],"video",t(),a),d=await j(s[0],"audio",t(),a);e({devices:i,video:o,audio:d}),e({call:a})}}));function ne(e){return e.enabled=!e.enabled,e.tracks.forEach(t=>{t.enabled=e.enabled}),e}const Ge={video:{facingMode:"user",width:1280,height:719},audio:null};async function Ye(e){console.log("start share screen");const t=e.sharedScreen,a=e.call,i=r=>{var o;r.onended=d=>{console.log(`${d} ON ENDED`)},console.log("Adding screenshare track to call",r),r.contentHint="screenshare",e.local.addTrack(r);const s=(o=a.conn)==null?void 0:o.addTrack(r);return r.sender=s,r};return t.tracks=(await navigator.mediaDevices.getDisplayMedia()).getTracks().map(i),t.enabled=!0,t}async function Je(e){console.log("stop share screen");const t=e.sharedScreen,a=e.call,i=r=>{var s;console.log("Removing screenshare track from call",r),e.local.removeTrack(r);try{(s=a.conn)==null||s.removeTrack(r.sender)}catch(o){console.log(o)}r.stop()};return t.tracks.forEach(i),t.enabled=!1,t}async function j(e,t,a,i){var c;const r=a[t],s=g=>{var f;console.log("Adding track to call",g),a.local.addTrack(g);const h=(f=i.conn)==null?void 0:f.addTrack(g);return g.sender=h,g},o=g=>{var h;console.log("Removing track from call",g),a.local.removeTrack(g);try{(h=i.conn)==null||h.removeTrack(g.sender)}catch(f){console.log(f)}g.stop()},d={[t]:w({deviceId:e.deviceId},Ge[t])},l=await((c=navigator.mediaDevices)==null?void 0:c.getUserMedia(d));return r.tracks.forEach(o),t==="audio"?r.tracks=l.getAudioTracks().map(s):t==="video"&&(r.tracks=l.getVideoTracks().map(s)),r.device=e,r}const Qe=({className:e="",primary:t=""})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,fillRule:"evenodd",d:"M15.78 14.36a1 1 0 0 1-1.42 1.42l-2.82-2.83-2.83 2.83a1 1 0 1 1-1.42-1.42l2.83-2.82L7.3 8.7a1 1 0 0 1 1.42-1.42l2.83 2.83 2.82-2.83a1 1 0 0 1 1.42 1.42l-2.83 2.83 2.83 2.82z"})),ae=a=>{var i=a,{children:e}=i,t=I(i,["children"]);return n.createElement(fe,w({},t),n.createElement(be,{className:"fixed z-10 top-0 left-0 right-0 bottom-0 dark:bg-white bg-black opacity-30"}),e)},se=n.forwardRef((s,r)=>{var o=s,{children:e,showCloseIcon:t=!0,className:a="p-6"}=o,i=I(o,["children","showCloseIcon","className"]);return n.createElement(me,S(w({className:"fixed z-40 top-1/2 left-1/2 bg-gray-100 rounded-xl default-ring transform -translate-y-1/2 -translate-x-1/2"},i),{ref:r}),n.createElement("div",{className:`relative ${a}`},e,t&&n.createElement(pe,{className:"absolute top-2 right-2 text-gray-300 dark:text-gray-700 hover:text-gray-400 dark:hover:text-gray-500 focus:text-gray-400 dark:focus:text-gray-500 default-ring rounded"},n.createElement(Qe,{className:"w-7 h-7",primary:"fill-current"}))))}),Xe=we,Ze=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:a,d:"M13.59 12l6.7-6.7A1 1 0 0 1 22 6v12a1 1 0 0 1-1.7.7L13.58 12z"}),n.createElement("rect",{width:"14",height:"14",x:"2",y:"5",className:t,rx:"2"})),et=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,d:"M11 4h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V6h-2v12h2v-2a1 1 0 0 1 2 0v3a1 1 0 0 1-1 1h-3v1a1 1 0 0 1-1.27.96l-6.98-2A1 1 0 0 1 2 19V5a1 1 0 0 1 .75-.97l6.98-2A1 1 0 0 1 11 3v1z"}),n.createElement("path",{className:a,d:"M18.59 11l-1.3-1.3c-.94-.94.47-2.35 1.42-1.4l3 3a1 1 0 0 1 0 1.4l-3 3c-.95.95-2.36-.46-1.42-1.4l1.3-1.3H14a1 1 0 0 1 0-2h4.59z"})),tt=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:a,d:"M12 1a4 4 0 0 1 4 4v6a4 4 0 1 1-8 0V5a4 4 0 0 1 4-4z"}),n.createElement("path",{className:t,d:"M13 18.94V21h3a1 1 0 0 1 0 2H8a1 1 0 0 1 0-2h3v-2.06A8 8 0 0 1 4 11a1 1 0 0 1 2 0 6 6 0 1 0 12 0 1 1 0 0 1 2 0 8 8 0 0 1-7 7.94z"})),nt=({className:e,primary:t,secondary:a})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 272 272",className:e},n.createElement("path",{className:t,d:`M263,14.043H9c-4.971,0-9,4.029-9,9v166c0,4.971,4.029,9,9,9h99.622v41.914H93c-4.971,0-9,4.029-9,9s4.029,9,9,9h86
                c4.971,0,9-4.029,9-9s-4.029-9-9-9h-15.622v-41.914H263c4.971,0,9-4.029,9-9v-166C272,18.072,267.971,14.043,263,14.043z
                 M254,32.043v110H18v-110H254z M145.378,239.957h-18.756v-41.914h18.756V239.957z M18,180.043v-20h236v20H18z`})),at=({className:e="",primary:t="",secondary:a=""})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:e},n.createElement("path",{className:t,d:"M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2zm11 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm-8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"}),n.createElement("path",{className:a,d:"M9.73 14H17a1 1 0 0 1 0 2H9.73a2 2 0 0 0 0-2zm4.54-6a2 2 0 0 0 0 2H7a1 1 0 1 1 0-2h7.27z"})),U=n.forwardRef(({defaultPressed:e,pressed:t,onPressedChange:a,disabled:i,children:r,className:s,toggleClass:o},d)=>{const[l,c]=p.exports.useState(e),g=!!a,h=g?t:l,f=g?a:c,v=o!=null?o:"text-pink-900 bg-pink-500";return n.createElement(ve,{className:x("flex items-center justify-center default-ring rounded-full",i&&h&&"text-gray-400 bg-gray-700",h&&"text-gray-200 bg-gray-700",!h&&v,s),pressed:h,onPressedChange:f,disabled:i,ref:d},r)});function st(){const{ongoingCall:e}=M(),{audio:t,video:a,devices:i}=y(),r=i.filter(l=>l.kind==="videoinput"),s=i.filter(l=>l.kind==="audioinput"),o=l=>{const c=r[parseInt(l.target.value)];a.changeDevice(c,e)},d=l=>{const c=s[parseInt(l.target.value)];t.changeDevice(c,e)};return n.createElement("div",{className:"space-y-6"},n.createElement("div",{className:"VideoInputs"},n.createElement("h2",{className:"font-semibold"},"Camera"),n.createElement("select",{className:"input default-ring bg-gray-200",onChange:o},r.map((l,c)=>n.createElement("option",{key:c,value:c},l.label===""?l.groupId:l.label)))),n.createElement("div",{className:"AudioInputs"},n.createElement("h2",{className:"font-semibold"},"Microphone"),n.createElement("select",{className:"input default-ring bg-gray-200",onChange:d},s.map((l,c)=>n.createElement("option",{key:c,value:c},l.label===""?l.groupId:l.label)))))}const it=({className:e})=>{const{push:t}=J(),{audio:a,video:i,sharedScreen:r}=y(d=>({audio:d.audio,video:d.video,sharedScreen:d.sharedScreen})),s=M(d=>d.hangup),o=p.exports.useCallback(()=>{s(),a.tracks.forEach(d=>d.stop()),i.tracks.forEach(d=>d.stop()),t("/")},[]);return n.createElement("div",{className:x("flex justify-center p-3 space-x-3",e)},n.createElement(U,{className:"w-10 h-10",pressed:i.enabled,onPressedChange:i.toggle},n.createElement(Ze,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Video")),n.createElement(U,{className:"w-10 h-10",pressed:a.enabled,onPressedChange:a.toggle},n.createElement(tt,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Audio")),n.createElement(U,{className:"w-10 h-10",pressed:!r.enabled,onPressedChange:r.toggle,toggleClass:"text-blue-900 bg-blue-500"},n.createElement(nt,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Screenshare")),n.createElement(ae,null,n.createElement(Xe,{className:"flex justify-center items-center w-10 h-10 text-gray-200 bg-gray-700 rounded-full default-ring"},n.createElement(at,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Devices")),n.createElement(se,{className:"w-full max-w-xl py-8 px-12"},n.createElement(st,null))),n.createElement("button",{className:"flex justify-center items-center w-10 h-10 text-pink-900 bg-pink-500 rounded-full default-ring",onClick:o},n.createElement(et,{className:"w-6 h-6",primary:"fill-current opacity-80",secondary:"fill-current"}),n.createElement("span",{className:"sr-only"},"Hang up")))},rt=({className:e})=>n.createElement("span",{className:`flex-none inline-block relative ${e}`},n.createElement("span",{className:"block absolute w-full h-full border-2 border-transparent border-t-pink-400 rounded-full animate-spin"}),n.createElement("span",{className:"block relative w-full h-full border border-pink-700 rounded-full"}));function ot(e){const t=e.srcObject,a=p.exports.useRef(null),i=S(w({},e),{autoPlay:!0,ref:a});return delete i.srcObject,p.exports.useEffect(()=>{!a.current||(a.current.srcObject=t)},[a,t]),n.createElement("video",i,null)}const z=r=>{var s=r,{size:e,className:t,isScreenshare:a}=s,i=I(s,["size","className","isScreenshare"]);const o=a?"rotateY(0deg)":"rotateY(180deg)";return n.createElement("div",{className:x(e==="xs-mini"&&"w-20 sm:w-28 shadow-md rounded-xl",e==="mini"&&"w-32 sm:w-64",e==="large"&&"h-1",t)},n.createElement(ot,S(w({},i),{className:x("h-full w-full object-cover md:object-contain"),style:{transform:o}})))},lt=()=>n.createElement(n.Fragment,null,n.createElement("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"},n.createElement("div",{className:"flex items-center mb-2"},n.createElement(rt,{className:"h-6 w-6 mr-2"}),n.createElement("h2",{className:"font-semibold text-xl text-pink-400"},"Connecting...")),n.createElement("p",{className:"text-gray-300"},"This could take up to a minute."))),ct=({connected:e})=>{var c,g;const{local:t,remote:a,sharedScreen:i,video:r}=y(h=>({local:h.local,remote:h.remote,sharedScreen:h.sharedScreen,video:h.video})),s=((g=(c=r.tracks[0])==null?void 0:c.getSettings())==null?void 0:g.aspectRatio)>1||!0,o=a.getVideoTracks().length>1;var d=null,l=null;if(o){const h=a.getVideoTracks()[1];l=new MediaStream([h])}if(i.enabled){const h=t.getVideoTracks()[1];d=new MediaStream([h])}return n.createElement(n.Fragment,null,n.createElement("div",{className:"relative w-full h-full bg-gray-500 overflow-hidden lg:rounded-xl"},n.createElement("div",{className:"absolute z-10 top-2 left-2 sm:top-6 sm:left-6"},n.createElement(z,{size:s?"mini":"xs-mini",muted:!0,isScreenshare:!1,srcObject:t,className:x("border border-white",s&&"aspect-w-16 aspect-h-9",!s&&"aspect-w-9 aspect-h-16")}),i.enabled&&n.createElement(z,{size:s?"mini":"xs-mini",muted:!0,isScreenshare:!0,srcObject:d,className:x("border border-white",s&&"aspect-w-16 aspect-h-9",!s&&"aspect-w-9 aspect-h-16")})),n.createElement("div",{id:"remotevideos",className:"h-full w-full flex flex-col"},n.createElement(z,{size:"large",className:"flex-1",isScreenshare:!1,srcObject:a,muted:!1}),o&&n.createElement(z,{size:"large",className:"flex-1",isScreenshare:!0,controls:!0,srcObject:l,muted:!1})),!e&&lt(),n.createElement(it,{className:"absolute z-10 bottom-0 left-1/2 transform -translate-x-1/2"})))},dt=({placeCall:e})=>{const{register:t,handleSubmit:a,reset:i,watch:r}=Y({mode:"onChange",defaultValues:{ship:""}}),s=r("ship"),o=p.exports.useCallback(({ship:d})=>{!d||(e(A(d)),i())},[]);return n.createElement("form",{onSubmit:a(o),className:"p-12 bg-gray-200 rounded-xl shadow-xl"},n.createElement("label",{htmlFor:"ship",className:"sr-only"},"Ship"),n.createElement("div",{className:"flex rounded-md focus-within:ring-2 ring-pink-300 focus-within:outline-none"},n.createElement("input",w({id:"ship",type:"text",placeholder:"Ship",className:"flex-1 input min-w-[200px] font-semibold font-mono rounded-r-none focus:outline-none"},t("ship"))),n.createElement("button",{type:"submit",className:"flex-none button px-6 text-pink-900 bg-pink-500 disabled:text-gray-900 disabled:bg-gray-400 disabled:cursor-default rounded-l-none",disabled:!Ee.isValidPatp(`~${A(s)}`||"")&&s.length>0},"Call")))};var ut="/apps/urchatfm/assets/enter-call.c4287b6d.wav";const ht=()=>{const e=p.exports.useCallback(()=>{},[]);return n.createElement(Se,{defaultOpen:!0,onOpenChange:e},n.createElement(xe,{className:"fixed bottom-4 right-4 inline-block max-w-sm px-8 py-4 space-y-4 bg-gray-100 rounded-xl shadow-lg"},n.createElement("h2",null,"You won't hear incoming calls until you hit this button or interact with the page"),n.createElement(ye,{className:"flex-1 button text-pink-900 bg-pink-500 default-ring"},"Turn On Ringer")))},gt=()=>{const e=p.exports.useCallback(t=>t.preventDefault(),[]);return n.createElement(ae,{defaultOpen:!0},n.createElement(se,{onPointerDownOutside:e,onFocusOutside:e,onInteractOutside:e,showCloseIcon:!1,className:"max-w-lg p-8 text-gray-700"},n.createElement("p",null,"urChatFM is built on top of WebRTC which requires HTTPS to function. You may need to provision a certificate for your Urbit, or you just need to visit the HTTPS version of your site."),n.createElement("div",{className:"flex items-center mt-4 space-x-4"},n.createElement("a",{className:"button text-pink-900 bg-pink-500 default-ring",href:`https://${location.hostname}${location.port&&":"+location.port}${location.pathname}`},"Try HTTPS version of this page"),n.createElement("a",{className:"button text-pink-900 bg-pink-500 default-ring",href:"https://urbit.org/using/os/basics#configuring-ssl"},"Configure SSL certificate"))))},mt=({placeCall:e,ship:t})=>{const a=()=>{e(t)};return n.createElement(n.Fragment,null,n.createElement("div",{className:"flex flex-row"},n.createElement("p",null,t),n.createElement("button",{type:"submit",onClick:a,className:"button px-6 text-pink-900 bg-pink-500 disabled:text-gray-900 disabled:bg-gray-400 disabled:cursor-default"},"Call")))},pt=({placeCall:e})=>{const{fetchPals:t}=M(),a=s=>{e(A(s))},i=()=>{console.log("TEST");const s=t();console.log(s)},r=["~zod","~bus","~datwet"];return n.createElement(n.Fragment,null,n.createElement("button",{type:"submit",onClick:i,className:"button bg-blue-200"},"FIND MY FRIENDS"),r.map(s=>n.createElement(mt,{ship:s,placeCall:a})))};function ft(){const{incomingCall:e,ongoingCall:t,answerCall:a,placeCall:i,rejectCall:r,hangup:s}=M(),{resetStreams:o,getDevices:d}=y(m=>({getDevices:m.getDevices,resetStreams:m.resetStreams})),{push:l}=J(),[c,g]=p.exports.useState(null),[h,f]=p.exports.useState(!1),[v,C]=p.exports.useState([]),$=location.protocol.startsWith("https")||location.hostname==="localhost";p.exports.useEffect(()=>(window.addEventListener("beforeunload",s),()=>window.removeEventListener("beforeunload",s)),[]),p.exports.useEffect(()=>{if($&&t){const m=new Audio(ut);m.volume=.3,m.play(),l(`/chat/${t.conn.uuid}`);const b=()=>d(t);return navigator.mediaDevices.addEventListener("devicechange",b),()=>navigator.mediaDevices.removeEventListener("devicechange",b)}},[t]);const V=p.exports.useCallback(m=>{console.log("Incoming track event",m);const{remote:b}=y.getState();b.addTrack(m.track),y.setState({remote:b})},[]),ie=async()=>{o();const m=await a((b,k)=>{f(!1),C([]),k.addEventListener("datachannel",N=>{const D=N.channel;D.onopen=()=>f(!0),D.onmessage=_=>{const R=_.data;C(oe=>[{speaker:b,message:R}].concat(oe)),console.log("channel message",R)},g(D)}),k.ontrack=V});d(m)},K=async m=>{o();const b=await i(m,k=>{console.log("placing call"),f(!1),C([]);const N=k.createDataChannel("urchatfm");N.onopen=()=>f(!0),N.onmessage=D=>{const _=D.data;C(R=>[{speaker:"~"+m,message:_}].concat(R)),console.log("channel message from ~"+m+": "+_)},g(N),k.ontrack=V});d(b)},re=p.exports.useCallback(m=>{c==null||c.send(m);const b=[{speaker:"me",message:m}].concat(v);console.log(v,b),C(b)},[v,c]);return n.createElement("main",{className:"relative flex flex-col lg:flex-row lg:gap-6 w-full h-full lg:p-8 text-gray-700"},n.createElement("section",{className:"flex-auto lg:flex-1 flex flex-col justify-center h-[50%] lg:h-auto"},n.createElement(Q,null,n.createElement(P,{path:"/chat/:id"},n.createElement(ct,{connected:h})),n.createElement(P,{path:"/"},n.createElement("div",{className:"flex justify-center items-center w-full h-full bg-pink-100 rounded-xl"},n.createElement("div",null,n.createElement("h1",{className:"mb-6 mx-12 text-3xl font-semibold font-mono"},"urChatFM"),n.createElement(dt,{placeCall:K})))))),n.createElement("aside",{className:"flex-auto lg:flex-none lg:w-[33vw] lg:max-w-sm h-[50%] lg:h-auto"},n.createElement(Q,null,n.createElement(P,{path:"/chat/:id"},n.createElement(qe,{sendMessage:re,messages:v,ready:h})),n.createElement(P,{path:"/"},n.createElement("div",{className:"h-full bg-gray-300 lg:rounded-xl"},n.createElement("h1",{className:"mb-6 mx-3 text-3xl font-semibold font-mono"},"%pals"),n.createElement(pt,{placeCall:K}))))),e&&n.createElement(Be,{caller:e.call.peer,answerCall:ie,rejectCall:r}),$&&n.createElement(ht,null),!$&&n.createElement(gt,null))}function bt(){return n.createElement(Ce,{basename:"/apps/urchatfm"},n.createElement(ft,null))}ke.render(n.createElement(n.StrictMode,null,n.createElement(bt,null)),document.getElementById("root"));
